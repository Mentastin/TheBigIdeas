\chapter{Universal algebra}
TODO: forgetful functors.

\section{Syntax}
\subsection{Signature}
\begin{definition}
A \udef{signature} or \udef{operational type} or \udef{operator domain} is a pair $(\Omega, \alpha)$ where $\Omega$ is a set whose elements are called \udef{operator symbols} or \udef{function symbols} and $\alpha: \Omega \to \Ord$ is a function.
\begin{itemize}
    \item We call $\alpha(\omega)$ the \udef{arity} of the operator $\omega\in\Omega$.
    \item If the arity of $\omega\in\Omega$ is $n$, then we say $\omega$ is an \udef{$n$-ary} operator.
    \item If the arity of $\omega\in\Omega$ is the first limit ordinal (i.e.\ $\omega$, confusingly), we say $\omega$ has \udef{countable arity}.
\end{itemize}
\end{definition}
We also say \udef{unary} instead of $1$-ary, \udef{binary} instead of $2$-ary and \udef{ternary} instead of $3$-ary.

\subsection{Terms}
\begin{definition}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of \udef{variables} such that $\Omega\perp V$. The set $T(\Omega, V)$ of \udef{$\Omega$-terms} over $V$ is a subset of $(\Omega\uplus V)^*$ which is recursively defined by
\[ t\in T(\Omega, V) \iff \begin{cases}
\exists v\in V: t = \seq{v} \\
\exists \omega\in \Omega: (t_0 = \omega) \land \Big(t[1:] \in \strConcat^{\imf}\big(T(\Omega, V)^{\alpha(\omega)}\big) \Big).
\end{cases} \]
A term $t$ is called \udef{ground} if $t\in T(\Omega, \emptyset)$. We abbreviate $T(\Omega, \emptyset)$ as $T(\Omega)$.
\end{definition}
Thus $T(\Omega)$ is the set of ground terms.

TODO: prefix notation or Polish notation.

ALTERNATIVE: $\forall \omega\in\Omega: \forall t\in T(\Omega, V)^{\alpha(\omega)}: \seq{\omega}\concat \strInterleave\Big(\seq{\LB}\seq{\SEP}^{\alpha(\omega)-1}\seq{\RB}, t\Big) \in T(\Omega, V)$

\begin{lemma} \label{initialElementUATerm}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $t\in T(\Omega, V)$. Then either
\begin{itemize}
\item $t = \seq{v}$ for some $v\in V$; or
\item $t_0\in \Omega$.
\end{itemize}
In particular $\seq{}\notin T(\Omega, V)$.
\end{lemma}
\begin{proof}
TODO recursion invariant.
\end{proof}

\begin{lemma}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of variables. Then $\strConcat|_{T(\Omega, V)^*}: T(\Omega, V)^* \to (\Omega \uplus V)^*$ has a left inverse
\[ \splitTerms: \im\big(\strConcat|_{T(\Omega, V)^*}\big) \to T(\Omega, V)^* \]
defined resursively by
\[ \splitTerms(u) = \seq{u[:k]} \concat \splitTerms(u[k:]), \]
where $k = \min\setbuilder{k\in\N}{u[:k]\in T(\Omega,V)}$.
\end{lemma}
In particular $\splitTerms$ is defined on $\strConcat^\imf\big(T(\Omega, V)^1\big) = T(\Omega, V)$.
\begin{proof}
TODO
\end{proof}

Note (TODO): ability to make syntax forest implies ability to make syntax tree.

\subsubsection{Subterms and syntax tree}
TODO define syntax trees in general.

\begin{definition}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of variables. We define the \udef{$\syntaxTree$} function $\syntaxTree: T(\Omega, V) \to \powerset\big((\Omega \uplus V \uplus \N)^*\big)$ recursively by
\[ \syntaxTree(t) = \begin{cases}
\{\seq{}, \seq{t_0}\} & (t_0\in V) \\
\{\seq{}, \seq{t_0}\} \cup \bigcup_{i=0}^{\alpha(t_0)}\setbuilder{\seq{i}\concat p}{p\in \syntaxTree\big(\splitTerms(t[1:])_i\big)} & (t_0\in \Omega)
\end{cases}. \]
Given a syntax tree $\syntaxTree(t)$ of a term $t\in T(\Omega, V)$, we call the non-terminal nodes of $\syntaxTree(t)$ the \udef{positions} in the term $t$, denoted $\positions(t)$.
\end{definition}

\begin{lemma}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of variables. The $\syntaxTree$ function has a left-inverse $\treeToTerm: \im(\syntaxTree) \to T(\Omega, V)$ defined by
\[ \treeToTerm(A) = \seq{t} \concat \strConcat \seq{\treeToTerm\big(\setbuilder{u[1:]\in A}{u_1 = i}\big)}_{i:\seq{i}\in A} \]
\end{lemma}
\begin{proof}
TODO
\end{proof}


\begin{lemma} \label{positionsSyntaxTreeNumeric}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $t\in T(\Omega, V)$. Then
\begin{enumerate}
\item $\positions(t) = \syntaxTree(t) \cap \N^*$;
\item a node in $\syntaxTree(t)$ is terminal \textup{if and only if} it ends with some element of $\Omega \uplus V$.
\end{enumerate}
\end{lemma}
\begin{proof}
TODO
\end{proof}

\begin{proposition} \label{mappingsTermSyntaxTreePositions}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $t\in T(\Omega, V)$.
\begin{enumerate}
\item Let $\positions(t)\subseteq \N^*$ be ordered by depth-first ordering. There exists a similarity
\[ \leafAt_t: \big(0:\len(t)\big)\to \positions(t) \]
such that $\leafAt_t(k)\concat\seq{t_k}\in \syntaxTree(t)$.
\item The function 
\[(-)[0..\len(-)-1]: \big(\syntaxTree \setminus \positions(t)\big) \to \positions(t) \]
is a bijection.
\end{enumerate}
\end{proposition}
The similarity $\leafAt_t$ is unique by \ref{WOSetsUniqueSimilarity}.
\begin{proof}
TODO
\end{proof}
\begin{corollary}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $t\in T(\Omega, V)$. Then
\[ {\#\big(\positions(t)\big)} = \len(t) = {\#\big(\syntaxTree(t)\big)/2}. \]
\end{corollary}


\begin{definition}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of variables. Let $t\in T(\Omega, V)$ be a term and $p\in \positions(t)$ a position in $t$. Then we define the \udef{subterm} $t|_p$ by
\begin{align*}
\syntaxTree(t|_p) &\defeq \setbuilder{q\in (\Omega \uplus V \uplus \N)^*}{p\concat q \in \syntaxTree(t)} \\
&= (p \concat -)^\preimf\big(\syntaxTree(t)\big).
\end{align*}
\end{definition}
Thus
\[ t|_p \defeq \treeToTerm\Big((p \concat -)^\preimf\big(\syntaxTree(t)\big)\Big). \]

\begin{lemma}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables, $t\in T(\Omega, V)$ and $p\in \positions(t)$. Then
\[ (p \concat -)^\preimf\big(\syntaxTree(t)\big) \]
is a syntax tree and, in particular, $t|_p$ is well-defined.
\end{lemma}
\begin{proof}
TODO
\end{proof}

\begin{lemma}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables, $t\in T(\Omega, V)$, $p \in \positions(t)$ and $u\in (\Omega\uplus V\uplus \N)^*$. Then
\begin{enumerate}
\item $p\concat u \in \syntaxTree(t)$ \textup{if and only if} $u\in \syntaxTree(t|_p)$;
\item $p\concat q \in \positions(t)$ \textup{if and only if}  $q\in \positions(t|_p)$;
\item if $p\concat q \in \positions(t)$, then $t|_{p\concat q} = (t|_p)|_q$.
\end{enumerate}
\end{lemma}
\begin{proof}
(1) Clear from the definition.

(2) From point (1) and the fact that $p\concat q$ is non-terminal if and only if $q$ is non-terminal, by \ref{positionsSyntaxTreeNumeric}.

(3) We calculate
\begin{align*}
\syntaxTree\big((t|_p)|_q\big) &= (q\concat -)^\preimf\big(\syntaxTree(t|_p)\big) \\
&= \big((q\concat -)^\preimf \circ (p\concat -)^\preimf\big) \big(\syntaxTree(t)\big) \\
&= (p\concat q\concat -)^\preimf\big(\syntaxTree(t)\big) \\
&= \syntaxTree(t|_{p\concat q}).
\end{align*}
\end{proof}

\begin{lemma}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $s\in T(\Omega, V)$.
We can write $s = u\concat t \concat v$ for some $t\in T(\Omega, V)$ and some $u,v\in (\Omega\uplus V)^*$ \textup{if and only if} there exists $p\in\positions(s)$ such that $s|_p = t$.
\end{lemma}
\begin{proof}
$\boxed{\Rightarrow}$ We claim we can take $p = \leafAt_{u\concat t \concat v}\big(\len(u)\big)$. Indeed $p\concat \seq{t_0} \in \syntaxTree(u\concat t \concat v)$ by \ref{mappingsTermSyntaxTreePositions}. So $s|_p$ 
\end{proof}

\subsubsection{Substitution}
\begin{definition}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables, $s,t\in T(\Omega, V)$ and $p\in \positions(s)$. Then the \udef{substitution} of $t$ at $p$ in $s$ is defined by
\[ \syntaxTree\big(s[t/p]\big) \defeq \big(\syntaxTree(s) \setminus \upset\{p\}\big) \cup (p\concat -)^{\imf}\big(\syntaxTree(t)\big). \]
\end{definition}

\begin{proposition}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables, $s,t,r\in T(\Omega, V)$, $p\in \positions(s)$, $q\in\positions(t)$ and $n\in\positions(s|_p)$. Then
\begin{enumerate}
\item $s[t/p]|_p = t$;
\item $\big(s[t/p]\big)\big[r/(p\concat q)\big] = s[t[r/q]/p]$;
\item $s\big[t/(p\concat n)\big]|_p = (s|_p)[t/n]$;
\item $s\big[t/(p\concat n)\big][r/p] = s[r/p]$.
\end{enumerate}
If $p$ and $q$ are parallel positions in $\positions(s)$ (i.e.\ $p\not\sqsubseteq q$ and $p\not\sqsubseteq q$), then
\begin{enumerate} \setcounter{enumi}{4}
\item $s[t/p]|_q = s|_q$;
\item $\big(s[t/p]\big)[r/q] = \big(s[r/q]\big)[t/p]$.
\end{enumerate}
\end{proposition}
These proofs can also be given by induction on the length of the positions.

We can summarise
\begin{itemize}
\item point (6) as ``parallel substitutions commute''.
\end{itemize}
\begin{proof}
(1) We calculate, using the fact that $(p\concat -)$ is bijective,
\begin{align*}
\syntaxTree(s[t/p]|_p) &= (p\concat -)^\preimf\big(\syntaxTree(s[t/p])\big) \\
&= (p\concat -)^\preimf\Big(\big(\syntaxTree(s) \setminus \upset\{p\}\big) \cup (p\concat -)^{\imf}\big(\syntaxTree(t)\big)\Big) \\
&= (p\concat -)^\preimf\Big(\big(\syntaxTree(s) \setminus \upset\{p\}\big)\Big) \cup (p\concat -)^\preimf(p\concat -)^{\imf}\big(\syntaxTree(t)\big) \\
&= \emptyset \cup \syntaxTree(t) \\
&= \syntaxTree(t).
\end{align*}

(2) We calculate
\begin{align*}
\syntaxTree\big(s[t[r/q]/p]\big) &= \big(\syntaxTree(s) \setminus \upset\{p\}\big) \cup (p\concat -)^{\imf}\big(\syntaxTree(t[r/q])\big) \\
&= \big(\syntaxTree(s) \setminus \upset\{p\}\big) \cup (p\concat -)^{\imf}\Big(\big(\syntaxTree(t) \setminus \upset\{q\}\big) \cup (q\concat -)^{\imf}\big(\syntaxTree(r)\big)\Big) \\
&= \begin{multlined}[t] \big(\syntaxTree(s) \setminus \upset\{p\}\big) \cup \Big((p\concat -)^{\imf}\big(\syntaxTree(t)\big) \setminus \upset\{p\concat q\}\Big) \\ \cup (p \concat q\concat -)^{\imf}\big(\syntaxTree(r)\big) \end{multlined} \\
&= \begin{multlined}[t]\Big(\big(\syntaxTree(s) \setminus \upset\{p\}\big) \cup (p\concat -)^{\imf}\big(\syntaxTree(t)\big) \Big)\setminus \upset\{p\concat q\} \\ \cup (p \concat q\concat -)^{\imf}\big(\syntaxTree(r)\big) \end{multlined} \\
&= \big(\syntaxTree(s[t/p])\big)\setminus \upset\{p\concat q\} \cup (p \concat q\concat -)^{\imf}\big(\syntaxTree(r)\big) \\
&= \syntaxTree\Big(\big(s[t/p]\big)\big[r/(p\concat q)\big]\Big)
\end{align*}

(3) We calculate, using the fact that $(p\concat -)$ is bijective,
\begin{align*}
\syntaxTree\big((s|_p)[t/n]\big) &= \big(\syntaxTree(s|_p) \setminus \upset\{n\}\big) \cup (n\concat -)^{\imf}\big(\syntaxTree(t)\big) \\
&= (p\concat -)^\preimf\Big(\big(\syntaxTree(s) \setminus (p\concat -)^\imf(\upset\{n\})\big) \cup \big((p\concat -)^{\imf}\circ(n\concat -)^{\imf}\big)\big(\syntaxTree(t)\big)\Big) \\
&= (p\concat -)^\preimf\Big(\big(\syntaxTree(s) \setminus \upset\{p\concat n\}\big) \cup (p\concat n\concat -)^{\imf}\big(\syntaxTree(t)\big)\Big) \\
&= \syntaxTree\big(s[t/(p\concat n)]|_p\big).
\end{align*}

(4) We calculate
\begin{align*}
\syntaxTree\big(s\big[t/(p\concat n)\big][r/p]\big) &= \Big(\syntaxTree(s)\setminus\upset\{p\concat n\} \cup (p \concat n \concat -)^\imf\big(\syntaxTree(t)\big)\Big)[r/p] \\
&= \begin{multlined}[t]\Big(\syntaxTree(s)\setminus\upset\{p\concat n\} \cup (p \concat n \concat -)^\imf\big(\syntaxTree(t)\big)\Big)\setminus \upset\{p\} \\ \cup (p\concat -)^\imf\syntaxTree(r) \end{multlined} \\
&= \syntaxTree(s)\setminus\upset\{p\} \cup (p\concat -)^\imf\syntaxTree(r) \\
&= \syntaxTree\big(s[r/p]\big).
\end{align*}

(5) We calculate
\begin{align*}
\syntaxTree\big(s[t/p]|_q\big) &= (q\concat -)^{\preimf}\Big(\syntaxTree\big(s[t/p]\big)\Big) \\
&= (q\concat -)^{\preimf}\Big(\big(\syntaxTree(s)\setminus\upset\{p\}\big) \cup (p\concat -)^\imf\big(\syntaxTree(t)\big)\Big) \\
&= (q\concat -)^{\preimf}\big(\syntaxTree(s)\setminus\upset\{p\}\big) \\
&= (q\concat -)^{\preimf}\syntaxTree(s) \\
&=\syntaxTree(s|_q).
\end{align*}

(6) We calculate
\begin{align*}
\syntaxTree\Big(\big(s[t/p]\big)[r/q]\Big) &= \Big(\syntaxTree\big(s[t/p]\big) \setminus \upset\{q\}\Big) \cup (q\concat -)^\imf\syntaxTree(r) \\
&= \Big(\big((\syntaxTree(s)\setminus \upset\{p\}) \cup (p\concat -)^\imf\syntaxTree(t) \big) \setminus \upset\{q\}\Big) \cup (q\concat -)^\imf\syntaxTree(r) \\
&= \Big(\syntaxTree(s)\setminus \big(\upset\{p\} \cup \upset\{q\} \big)\Big) \cup (p\concat -)^\imf\syntaxTree(t) \cup (q\concat -)^\imf\syntaxTree(r) \\
&= \Big(\big((\syntaxTree(s)\setminus \upset\{q\}) \cup (q\concat -)^\imf\syntaxTree(r) \big) \setminus \upset\{p\}\Big) \cup (p\concat -)^\imf\syntaxTree(t) \\
&= \Big(\syntaxTree\big(s[r/q]\big) \setminus \upset\{p\}\Big) \cup (p\concat -)^\imf\syntaxTree(t) \\
&= \syntaxTree\Big(\big(s[r/q]\big)[t/p]\Big).
\end{align*}
\end{proof}

\subsubsection{Variable substitution}
\begin{definition}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of variables. An \udef{elementary variable substitution} is a partial function $\hat{\sigma}\in(V\not\to T(\Omega, V))$ with finite domain of definition.

We say $\hat{\sigma}$ \udef{instantiates} $x\in V$ if $x\in \preim(\hat{\sigma})$.

Given an elementary variable substitution $\hat{\sigma}$, we also define the \udef{(extended) variable substitution} $\sigma: (\Omega \uplus V)^*\to (\Omega \uplus V)^*$, defined recursively by
\[ \sigma(u) = \begin{cases}
\seq{} & (u = \seq{}) \\
\hat{\sigma}(u_0)\concat \sigma\big(u[1:]\big) & \big(u_0\in \preim(\hat{\sigma})\big) \\
u_0\concat \sigma\big(u[1:]\big) & \big(u_0\notin \preim(\hat{\sigma})\big)
\end{cases} \]
The set of all variable substitutions is denoted $\varSubs(\Omega, V)$.
\end{definition}
TODO rewrite definition with \emph{map}.

\begin{lemma}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables, $\hat{\sigma}: V\not\to T(\Omega, V)$ an elementary variable substitution and $t\in T(\Omega, V)$. Then $\sigma(t) \in T(\Omega, V)$. 
\end{lemma}
\begin{proof}
TODO
\end{proof}

\subsection{Syntactic consequence}
\subsubsection[Omega-identities]{$\Omega$-identities}
\begin{definition}
Let $(\Omega, \alpha)$ be a signature and $V$ a set of variables. An \udef{$\Omega$-identity} is an element of $T(\Omega, V)\times T(\Omega, V)$.

We call a set $E\subseteq T(\Omega, V)\times T(\Omega, V)$ \udef{closed under variable substitution} if for all variable substitutions $\sigma$, we have $(\sigma, \sigma)^\imf(E) \subseteq E$.

We call a set $E\subseteq T(\Omega, V)\times T(\Omega, V)$ \udef{closed under $\Omega$-operations} if for all operator symbols $\omega\in\Omega$ and $t,s\in \big(T(\Omega, V)\big)^{\alpha(\omega)}$ such that $(s_i, t_i)\in E$ for all $i\in \big(0:\alpha(\omega)\big)$, we have
\[ \big( \seq{\omega}\concat \strConcat(s), \seq{\omega}\concat \strConcat(t)\big) \in E. \]
\end{definition}

The closure of $E$ under variable substitutions is given by $\bigcup_{\sigma\in\varSubs(\Omega, V)}(\sigma, \sigma)^\imf(E)$.

\subsubsection{Reduction relations}
\begin{definition}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $E$ a set of $\Omega$-identities. We define the \udef{reduction relation} $\to_E$ on $T(\Omega, V)$ by $s\to_E t \defequiv$
\[ \exists u,v\in (\Omega\uplus V)^*: \exists (r_1, r_2)\in E: \exists \sigma\in \varSubs(\Omega, V):\; \begin{cases}
s = u \concat \sigma(r_1) \concat v \in T() \\
t = u \concat \sigma(r_2) \concat v.
\end{cases}  \]
\end{definition}

\begin{lemma}
The symmetric, transitive, reflexive closure of $\to_E$ is the smallest equivalence relation that contains $E$ and is closed under variable substitution and $\Omega$-operations.
\end{lemma}
\begin{proof}

\end{proof}

\begin{definition}
We denote the relation $\equiv_E$.
\end{definition}

\subsubsection{Syntactic consequence}
\begin{definition}
Let $(\Omega, \alpha)$ be a signature, $V$ a set of variables and $E$ a set of $\Omega$-identities. Then an element of $\equiv_E\setminus E$ is a \udef{syntactic consequence} of $E$.
\end{definition}

\section{Semantics}
\subsection{Algebras}
\begin{definition}
A \udef{structure} of type $(\Omega,\alpha)$, an \udef{$\Omega$-structure} or an \udef{$\Omega$-algebra}, is a set $A$, called the \udef{carrier}, equipped with a function
\[ \omega_A: A^{\alpha(\omega)}\to A \]
for each $\omega\in\Omega$. We call $\omega_A$ the \udef{interpretation} of $\omega$ in $A$.

If we allow the interpretations $\omega_A$ to be partial functions, we call $A$ a \udef{partial $\Omega$-structure}.

If $\alpha(\omega) = 0$ we take $\omega_A$ to be a constant.
\end{definition}


$A^{\alpha(\omega)}$ is a set of strings!!
TODO notation: we write $\omega_A(x)$ for $\omega_A(\seq{x})$ and
$c_A$ for $c_A(\seq{})$. Should we drop parentheses and have just juxtaposition for function application?? I.e. $\omega_A\seq{x}$ or $\omega'_A\seq{x,y}$?


\begin{definition}
Let $A$ be an $\Omega$-algebra. An \udef{$\Omega$-subalgebra} of $A$ is a subset that is closed under the operations of $\Omega$.
\end{definition}

\begin{lemma} \label{intersectionSubalgebra}
Let $A$ be an $\Omega$-algebra. Let $\mathcal{E}$ be a family of subalgebras. Then $\bigcap \mathcal{E}$ is also a subalgebra. 
\end{lemma}

\begin{definition}
Let $A$ be an $\Omega$-algebra and $X$ a subset of $A$. The subalgebra of $A$ \udef{generated} by $X$ is the intersection of all subalgebras containing $X$. We call $X$ the \udef{generating set} of this subalgebra.
\end{definition}
Every algebra has a (non-unique) generating set. For example the algebra itself.

\begin{definition}
The \udef{trivial} $\Omega$-algebra is the algebra generated by $\emptyset$.
\end{definition}

\subsection{Homomorphisms}
\begin{definition}
Let $A,B$ be $\Omega$-algebras. A \udef{homomorphism} of $\Omega$-algebras is a function $f:A\to B$ such that
\[ \forall \omega\in\Omega: \qquad f\circ \omega_A = \omega_B\circ f^{\alpha(\omega)}. \]
\end{definition}

\begin{proposition}
Let $f,g:A\to B$ be two homomorphisms between $\Omega$-algebras $A,B$. If $f,g$ agree on a generating set of $A$, then they are equal.
\end{proposition}
\begin{proof}
The set $\setbuilder{x\in A}{f(x) = g(x)}$ is a subalgebra of $A$. By hypothesis it contains a generating set of $A$ and thus it is all of $A$.
\end{proof}

\begin{proposition}
Let $f:A\to B$ be a homomorphism of $\Omega$-algebras. Then $\im f$ is a subalgebra of $B$.
\end{proposition}
\begin{proof}
Take some arbitrary $\omega\in\Omega$. Let $b\in(\im f)^{\alpha(\omega)}$. Then there exists an $a\in A^{\alpha(\omega)}$ such that $b = f^{\alpha(\omega)}$. So we have $\omega_B(b) = \omega_B(f^{\alpha(\omega)}(a)) = f(\omega_A(a)) \in \im f$.
\end{proof}

\begin{proposition}
Let $(\Omega,\alpha)$ be a signature. Then the $\Omega$-algebras form a category with homomorphisms as arrows.
\end{proposition}
Consequently we have the concepts of isomorphism, endomorphism and automorphism.

\begin{proposition} \label{bijectiveHomomorphism}
Let $f:A\to B$ be a bijective homomorphism. Then $f^{-1}$ is also a homomorphism and thus $f$ is an isomorphism.
\end{proposition}
\begin{proof}
Take arbitrary $\omega\in\Omega$. Then we compute, using \ref{covarianceContravarianceComposition},
\[ \omega_A (f^{-1})^{\alpha(\omega)} = f^{-1} f\omega_A (f^{-1})^{\alpha(\omega)} = f^{-1}\omega_B f^{\alpha(\omega)} (f^{-1})^{\alpha(\omega)} = f^{-1}\omega_B (f f^{-1})^{\alpha(\omega)} = f^{-1}\omega_B. \]
\end{proof}

\section{Relations on algebras}
\subsection{Direct product}
\begin{definition}
Let $\{A_i\}_{i\in I}$ be a family of $\Omega$-algebras. The \udef{direct product} $\prod_{i\in I} A_i$ is the $\Omega$-algebra whose carrier is the Cartesian product of $\{A_i\}_{i\in I}$ and where operations are carried out componentwise and relations are verified pointwise.

Similarly a \udef{direct power} of $A$ is a Cartesian power of $A$ with operations and relations defined componentwise.
\end{definition}

The direct product of $\{A,B\}$ is simply written $A\times B$.

\subsection{Relations as algebras}
\begin{definition}
Let $A,B$ be $\Omega$-algebras and $R$ a relation on $(A,B)$ is called \udef{$\Omega$-compatible} (or just \udef{compatible}) if $R$ is a subalgebra of $A\times B$.
\end{definition}
The requirement that $R$ be a subalgebra just means it is closed under the operations of $\Omega$. So $R$ is $\Omega$-compatible if
\[ \forall \omega\in\Omega: \qquad \omega_{A\times B}^\imf(R^{\alpha(\omega)}) \subseteq R. \]

\begin{lemma}
Let $A,B,C$ be $\Omega$-algebras and $\Gamma, \Delta$ $\Omega$-compatible relations on $(A, B)$ and $(B, C)$, respectively. Then
\begin{enumerate}
\item $\Gamma^{\transp} \subset B\times A$ is an $\Omega$-algebra;
\item $\Gamma;\Delta \subset A\times C$ is an $\Omega$-algebra;
\item for any subalgebra $A'$ of $A$, $A'\Gamma \subset B$ is an $\Omega$-algebra;
\item for any subalgebra $B'$ of $B$, $\Gamma B' \subset A$ is an $\Omega$-algebra.
\end{enumerate}
\end{lemma}

\subsection{Congruences}
\begin{definition}
Let $A$ be an $\Omega$-algebra. A \udef{congruence} $\mathfrak{q}$ on $A$ is an $\Omega$-compatible equivalence relation.
\end{definition}

\begin{example}
Any algebra has the \udef{trivial congruences} $I_A$ and $A^2$.
\end{example}

An algebra is \udef{simple} if there are no congruences on it other than the trivial ones. We assume a simple algebra is non-trivial.

\begin{lemma} \label{basicCongruenceLemma}
Let $\mathfrak{q}$ be a congruence on an $\Omega$-algebra $A$ and $B$ an $\Omega$-subalgebra of $A$. Then
\begin{enumerate}
\item $\mathfrak{q}^n$ is a congruence on $A^n$ for all $n\in \N$,
\item $\mathfrak{q}|_B^B$ is a congruence on $B$.
\end{enumerate}
\end{lemma}
\begin{proof}
(1) The extension of $\mathfrak{q}$ is an equivalence relation by \ref{relationPropertiesDirectProduct}.

TODO subalgebra of $(A^n)^2$ with canonical isomorphism.

(2) The restriction is clearly still reflexive, symmetric and transitive. It is an $\Omega$-algebra by \ref{intersectionSubalgebra}.
\end{proof}
For simplicity we may write $B/\mathfrak{q}$ instead of $B/(\mathfrak{q}|_B^B)$.

\begin{proposition} \label{kernelCongruence}
Let $f:A\to B$ be a homomorphism. Then $\ker f$ is a congruence on $A$.
\end{proposition}

\subsubsection{Lattice of congruences}

Congruences closed under intersection, so complete sublattice.

TODO universal property.

\subsubsection{Quotient algebras}
TODO: index free notation

\begin{proposition} \label{quotientAlgebra}
Let $A$ be an $\Omega$-algebra and $\mathfrak{q}$ an equivalence relation. Then there exists an interpretation of $A/\mathfrak{q}$ such that the function
\[ A \to A/\mathfrak{q}: a\mapsto [a]_\mathfrak{q} \]
is a homomorphism if and only if $\mathfrak{q}$ is a congruence.

Explicitly, this interpretation is unique and given by
\[ \omega_{A/\mathfrak{q}}([a_1]_{\mathfrak{q}},\ldots,[a_{\alpha(\omega)}]_{\mathfrak{q}}) = [\omega_A(a_1,\ldots, a_{\alpha(\omega)})]_{\mathfrak{q}} \qquad \forall \omega\in\Omega. \]\end{proposition}
\begin{proof}
The requirement that $[\cdot]_\mathfrak{q}$ be a homomorphism forces the interpretation $\omega_{A/\mathfrak{q}}$ of $\omega$ to be the one given.

We just need to show that $\omega_{A/\mathfrak{q}}$ is well-defined if and only if $\mathfrak{q}$ is a congruence. To that end, choose arbitrary $a_1, \ldots, a_{\alpha(\omega)}$ and $a'_1, \ldots, a'_{\alpha(\omega)}$ such that $a_1'\in[a_1]_\mathfrak{q}, \ldots, a'_{\alpha(\omega)}\in [a_{\alpha(\omega)}]_\mathfrak{q}$. This is equivalent to choosing $(a_1,a'_1),\ldots, (a_{\alpha(\omega)},a'_{\alpha(\omega)}) \in \mathfrak{q}$. Then
\begin{align*}
[\omega_A(a_1,\ldots, a_{\alpha(\omega)})]_{\mathfrak{q}} = [\omega_A(a'_1,\ldots, a'_{\alpha(\omega)})]_{\mathfrak{q}} &\iff (\omega_A(a_1,\ldots, a_{\alpha(\omega)}),\omega_A(a'_1,\ldots, a'_{\alpha(\omega)})) \in \mathfrak{q} \\
&\iff \omega_{A^2}((a_1,a'_1),\ldots, (a_{\alpha(\omega)},a'_{\alpha(\omega)})) \in \mathfrak{q}
\end{align*}
where the first statement is the requirement of being well-defined and the last is the requirement for being a subalgebra of $A^2$.
\end{proof}
\begin{definition}
The $\Omega$-algebra $A/\mathfrak{q}$ is called the \udef{quotient algebra} of $A$ by $\mathfrak{q}$. The function $A \to A/\mathfrak{q}: a\mapsto [a]_\mathfrak{q}$ is known as the quotient map.
\end{definition}

\begin{proposition}[Factor theorem] \label{factorTheorem}
Let $f:A\to B$ be a homomorphism of $\Omega$-algebras and $\mathfrak{q}$ a congruence on $A$ such that $\mathfrak{q}\subseteq \ker f$. Then there exists a unique homomorphism $f': A/\mathfrak{q} \to B$ such that
\[ \begin{tikzcd}
A \arrow[r, "{[\cdot]_{\mathfrak{q}}}"] \arrow[dr, swap, "f"] & A/\mathfrak{q} \arrow[d, dashed, "{f'}"] \\
& B
\end{tikzcd} \qquad\text{commutes.} \]
Further, $f'$ is injective \textup{if and only if} $\mathfrak{q} = \ker f$.
\end{proposition}
Note that $\ker f$ is a congruence by \ref{kernelCongruence}. We can also express $\mathfrak{q}\subseteq \ker f$ by saying that $f$ is constant on the $\mathfrak{q}$-equivalence classes. TODO: universal property.
\begin{proof}
We are forced to define $f'$ by $f'([a]_\mathfrak{q}) = f(a)$. To show the function is well-defined, take $a,a'\in A$ such that $[a]_\mathfrak{q} = [a']_\mathfrak{q}$, i.e.\ $(a,a')\in \mathfrak{q}$. This implies $(a,a')\in\ker f$, so $f(a) = f(a')$ and $f'$ is well-defined.

We see that $f'$ is a homomorphism by the calculation
\begin{align*}
f'(\omega_{A/\mathfrak{q}}([a_1], \ldots, [a_{\alpha(\omega)}])) &= f'([\omega_{A}(a_1, \ldots, a_{\alpha(\omega)})]) = f(\omega_{A}(a_1, \ldots, a_{\alpha(\omega)})) \\
&= \omega_B(f(a_1), \ldots f(a_{\alpha(\omega)})) = \omega_B(f'([a_1]), \ldots, f'([a_{\alpha(\omega)}])).
\end{align*}
Finally $f'$ is injective iff no two distinct $\mathfrak{q}$-classes are identified by $f'$, which is exactly the condition $\mathfrak{q} = \ker f$.
\end{proof}

\begin{lemma}
Let $A$ be an $\Omega$-algebra and $\mathfrak{q}$ a congruence on $A$. Then
\[ [(x,y)]_{\mathfrak{q}^2} = [x]_\mathfrak{q}\times [y]_\mathfrak{q}. \]
In particular $A^2/\mathfrak{q}^2 = \setbuilder{[x]_\mathfrak{q}\times [y]_\mathfrak{q}}{x,y\in A}$.
\end{lemma}
\begin{proof}
We calculate
\[ (a,b) \in [(x,y)]_{\mathfrak{q}^2} \iff a\mathfrak{q}x \land b\mathfrak{q}y \iff a\in [x]_\mathfrak{q} \land b\in [y]_\mathfrak{q} \iff (a,b)\in [x]_\mathfrak{q}\times [y]_\mathfrak{q}. \]
\end{proof}

\subsubsection{Isomorphism theorems}
\begin{theorem}[First isomorphism theorem] \label{firstIsomorphism}
Let $f:A\to B$ be a homomorphism of $\Omega$-algebras. Then we have the isomorphism
\[ A/\ker f \cong \im f. \]
\end{theorem}
\begin{proof}
From the factor theorem \ref{factorTheorem} we get an injective homomorphism $f': A/\ker f \to B$ which is made surjective by restricting the codomain to $\im f$. By \ref{bijectiveHomomorphism} this is an isomorphism.
\end{proof}

\begin{theorem}[Second isomorphism theorem]
Let $A$ be an $\Omega$-algebra, $B$ an $\Omega$-subalgebra of $A$ and $\mathfrak{q}$ a congruence on $A$. Then we have the isomorphism
\[ (\mathfrak{q}B)/\mathfrak{q} \cong B/(\mathfrak{q}\cap B^2). \]
\end{theorem}
Note that $\mathfrak{q}B = B\mathfrak{q}$ because $\mathfrak{q}$ is a congruence. Also $\mathfrak{q}\cap B^2 = \mathfrak{q}|_B^B$, so the quotient is well-defined by \ref{basicCongruenceLemma}. Further, $\mathfrak{q}$ should really be restricted in $(\mathfrak{q}B)/\mathfrak{q}$, as in \ref{basicCongruenceLemma}.
\begin{proof}
Take the homomorphism $[\cdot]_\mathfrak{q}:A \to A/\mathfrak{q}$ as defined in \ref{quotientAlgebra} and restrict it to $B$. Applying the first isomorphism theorem \ref{firstIsomorphism} yields the required result.
\end{proof}

\begin{theorem}[Third isomorphism theorem]
Let $A$ be an $\Omega$-algebra and $\mathfrak{q},\mathfrak{r}$ congruences on $A$ such that $\mathfrak{q} \subseteq \mathfrak{r}$. Then $\mathfrak{r}/\mathfrak{q}$ is a congruence on $A/\mathfrak{q}$ and we have the isomorphism
\[ (A/\mathfrak{q})/(\mathfrak{r}/\mathfrak{q}) \cong A/\mathfrak{r}. \]
\end{theorem}
This is a slight abuse of notation: clearly $\mathfrak{q}$ is a congruence on $A$, but $\mathfrak{r}\subseteq A^2$. What we mean is that we take the quotient ``pointwise'':
\[ \mathfrak{r}/\mathfrak{q} = \setbuilder{([x]_\mathfrak{q}, [y]_\mathfrak{q})}{(x,y)\in \mathfrak{r}}. \]
\begin{proof}
Applying the factor theorem \ref{factorTheorem} to the homomorphism $A\to A/\mathfrak{r}$ from \ref{quotientAlgebra}. We get a surjective homomorphism
\[ f: A/\mathfrak{q} \to A/\mathfrak{r}: [a]_\mathfrak{q} \mapsto [a]_{\mathfrak{r}}. \]
We apply the first isomorphism theorem \ref{firstIsomorphism} to this homomorphism to get $(A/\mathfrak{q})/\ker f \cong A/\mathfrak{r}$. We just need to show that $\ker f = \mathfrak{r}/\mathfrak{q}$.

Indeed
\[ ([x]_\mathfrak{q},[y]_\mathfrak{q}) \in \ker f \iff [x]_\mathfrak{r} = [y]_\mathfrak{r} \iff (x, y)\in \mathfrak{r} \iff ([x]_\mathfrak{q},[y]_\mathfrak{q}) \in \mathfrak{r}/\mathfrak{q}. \]
\end{proof}
In particular, we see that $A/\mathfrak{q}$ is simple if and only if $\mathfrak{q}$ is a maximal proper congruence on $A$.

\section{Constructions}
\subsection{Pointwise algebras of functions}
\begin{definition}
Let $X$ be a set and $A$ an $\Omega$-algebra. Then the \udef{pointwise algebra} $(X\to A)$ is the set $(X\to A)$ and each $\omega\in\Omega$ is given the interpretation
\[ \omega_{X\to A} \defeq \omega_A\circ -.  \]
\end{definition}

\chapter{Magmas}
\begin{definition}
A \udef{magma} or \udef{groupoid} is an algebra whose signature contains a single ginary operator.

Let $A$ be the carrier of the algebra and $\boldsymbol{\cdot}$ the interpretation of the operator. We denote the magma as $\sSet{A,\boldsymbol{\cdot}}$. We call $\sSet{A,\boldsymbol{\cdot}}$
\begin{itemize}
\item a \udef{semigroup} if $\boldsymbol{\cdot}$ is associative;
\item a \udef{monoid} if $\boldsymbol{\cdot}$ is associative and has an identity;
\item a \udef{group} if $\boldsymbol{\cdot}$ is associative, has an identity and every $a\in A$ has an inverse.
\end{itemize}
We call a magma \udef{commutative} if its operation is commutative.

If $\sSet{A,\boldsymbol{\cdot}}$ is a monoid or group with identity $e$, we denote the monoid/group as $\sSet{A,\boldsymbol{\cdot}, e}$.
\end{definition}
TODO: change of signature for monoid!

Let $x,y\in A$. We usually write $x\boldsymbol{\cdot} y$ instead of $\boldsymbol{\cdot}(x,y)$. (TODO ref infix notation)

\begin{definition}
We write $x^n$ to abbreviate $\underbrace{x\cdot x\cdot \ldots \cdot x}_{\text{$n$ times}}$.

If $x^2 = x$, we say $x$ is an \udef{idempotent}.
\end{definition}

\begin{lemma}
Let $\sSet{M,\cdot}$ be a magma and $a\in M$. Then $a\cdot M \subseteq M$.
\end{lemma}

\begin{definition}
Let $\sSet{A,\boldsymbol{\cdot}}$ be a magma of finite cardinality. A table containing all possible outputs of the function $\boldsymbol{\cdot}$, i.e.\ of the form
\[ \begin{array}{l|llll}
\boldsymbol{\cdot} & a_1 & a_2 & \hdots & a_n \\ \hline
a_1 & a_1\boldsymbol{\cdot}a_1 & a_1\boldsymbol{\cdot}a_2 & \hdots & a_1\boldsymbol{\cdot}a_n \\
a_2 & a_2\boldsymbol{\cdot}a_1 & a_2\boldsymbol{\cdot}a_2 & \hdots & a_2\boldsymbol{\cdot}a_n \\
\vdots & \vdots & \vdots &  & \vdots \\
a_n & a_n\boldsymbol{\cdot}a_1 & a_n\boldsymbol{\cdot}a_2 & \hdots & a_n\boldsymbol{\cdot}a_n
\end{array} \]
is called a \udef{Cayley table}.
\end{definition}
A magma is completely determined by its Cayley table.

\begin{proposition} \label{leftRightInverseMonoid}
Let $(M,\cdot,e)$ be a monoid and $a\in M$. If $a$ has both a left inverse $l$ and a right inverse $r$, then $l=r$.
\end{proposition}
\begin{proof}
We calculate
\[ l = l\cdot e = l\cdot(a\cdot r) = (l\cdot a)\cdot r= e\cdot r = r. \]
\end{proof}

\section{Semigroups}
\begin{lemma}
Let $S$ be a semigroup. If $a\in S$ is idempotent, then $\{a\}$ is a subsemigroup.
\end{lemma}
\begin{corollary}
Let $S$ be a semigroup.
\begin{enumerate}
\item If $S$ contains an identity $e$, then $\{e\}$ is a subsemigroup.
\item If $S$ contains an absorbing element $u$, then $\{u\}$ is a subsemigroup.
\end{enumerate}
\end{corollary}

\begin{proposition} \label{groupCriterion}
Let $S$ be a semigroup. Then $S$ is a group \textup{if and only if} for all $a\in S$
\[ aS = S = Sa. \]
\end{proposition}
\begin{proof}
If $S$ is a group, then we have for all $a\in S$
\[ S \supseteq aS \supseteq aa^{-1}S = S. \]
Similarly we also have $S = Sa$.

For the converse: from $aS = S$, we het that there exists an $x\in S$ such that $ax = a$. We claim $x$ is a right-identity for $S$. Indeed, take arbitrary $b\in S$. Then $b = ya$ for some $y$ and so $bx = yax = ya b$. In the same way we can also find a left-identity. So $S$ contains an identity $e$ by \ref{leftRightIdentity}.

Then for all $a$ we can find $u,v\in S$ such that $au = e = va$. This means $a$ has an inverse by \ref{leftRightInverseMonoid}.
\end{proof}


\subsection{Adjoining identities and absorbing elements}
\subsubsection{Adjoining identity}
\begin{definition}
Let $\sSet{S,\boldsymbol{\cdot}}$ be a semigroup. We define
\[ \widetilde{S} \defeq \begin{cases}
S & \text{if $S$ has an identity} \\
S\uplus \{e\} & \text{if $S$ has no identity.}
\end{cases} \]
and also
\[ \widetilde{\boldsymbol{\cdot}} \quad\defeq\quad \widetilde{S}\times \widetilde{S}\to \widetilde{S}: (a,b) \mapsto \begin{cases}
a\boldsymbol{\cdot} b & a,b\in S \\
b & a = e \\
a & b = e.
\end{cases} \]
\end{definition}


\subsubsection{Adjoining an absorbing element}
\begin{definition}
Let $\sSet{S,\cdot}$ be a semigroup. We define
\[ \widehat{S} \defeq \begin{cases}
S & \text{if $S$ has an absorbing element} \\
S\uplus \{u\} & \text{if $S$ has no absorbing element.}
\end{cases} \]
and also
\[ \widehat{\boldsymbol{\cdot}} \quad\defeq\quad \widehat{S}\times \widehat{S}\to \widehat{S}: (a,b) \mapsto \begin{cases}
a\boldsymbol{\cdot} b & a,b\in S \\
u & (a = u \lor b = u.
\end{cases} \]
\end{definition}

TODO: link with partial semigroup.

\subsection{Subsets and subsemigroups}
\subsubsection{Ideals}
\begin{definition}
Let $S$ be a semigroup and $A\subseteq S$ a non-empty subset. Then $A$ is called
\begin{itemize}
\item a \udef{left ideal} if $SA \subseteq A$;
\item a \udef{right ideal} if $AS \subseteq A$;
\item a \udef{(two-sided) ideal} if $A$ is both a left and a right ideal.
\end{itemize}
Clearly $S$ is an ideal. If $u\in S$ is an absorbing element, then $\{u\}$ is an ideal. If an ideal is neither of these two, it is called \udef{proper}.
\end{definition}

\begin{lemma}
Let $\sSet{S,\cdot}$ be a semigroup and $a\in S$. Then
\begin{enumerate}
\item $\widetilde{S}a = Sa \cup \{a\}$ is a left ideal;
\item $a\widetilde{S} = aS \cup \{a\}$ is a right ideal;
\item $\widetilde{S}a\widetilde{S} = SaS \cup Sa \cup aS \cup \{a\}$ is an ideal.
\end{enumerate}
In particular $\widetilde{S}a \subseteq S$, $a\widetilde{S} \subseteq S$ and $\widetilde{S}a\widetilde{S} \subseteq S$.
\end{lemma}

\begin{definition}
We call
\begin{itemize}
\item $\widetilde{S}a$ the principal left ideal generated by $a$; 
\item $a\widetilde{S}$ the principal right ideal generated by $a$; 
\item $\widetilde{S}a\widetilde{S}$ the principal ideal generated by $a$.
\end{itemize}
\end{definition}

\subsubsection{Generated semigroups}
TODO!

\subsubsection{Periodic semigroups}
Period and index.

\subsection{Homomorphism}

\begin{proposition}
Let $S$ be a semigroup. Then the functions
\begin{align*}
&\lambda: S \to (\widetilde{S} \to \widetilde{S}) : a\mapsto (\lambda_a: x\mapsto ax) \\
&\rho: S \to (\widetilde{S} \to \widetilde{S}): a\mapsto (\rho_a: x\mapsto xa)
\end{align*}
are injective homomorphisms.
\end{proposition}
Note that for all $s\in S$ we view $\lambda_a$ as a function $\widetilde{S} \to \widetilde{S}$. This is necessary for injectivity.
\begin{proof}
The functions $\lambda, \rho$ are homomorphisms by associativity.

For injectivity, let $\lambda_a = \lambda_b$. Then $a = a\cdot e = \lambda_a(e) = \lambda_b(e) b\cdot e = b$.
\end{proof}

\begin{definition}
We call $\lambda$ ($\rho$) the \udef{extended left (right) regular representation} of $S$.
\end{definition}

\subsubsection{Congruences}
\begin{definition}
Let $\sSet{S,\boldsymbol{\cdot}}$ be a semigroup and $R$ a relation on $S$. Then $R$ is called
\begin{itemize}
\item \udef{left compatible} if it is $\Omega$-compatible with $\Omega = \setbuilder{\lambda_a}{a\in S}$;
\item \udef{right compatible} if it is $\Omega$-compatible with $\Omega = \setbuilder{\rho_a}{a\in S}$;
\item \udef{compatible} if it is $\Omega$-compatible with $\Omega = \{\boldsymbol{\cdot}\}$.
\end{itemize}
If the relation $R$ is additionally an equivalence relation, then $R$ is called a \udef{( left / right) congruence}.
\end{definition}

In other words:
\begin{itemize}
\item $R$ is left compatible if $\forall x,y,a\in S: \; xRy \implies (ax)R(ay)$;
\item $R$ is right compatible if $\forall x,y,a\in S: \; xRy \implies (xa)R(ya)$;
\item $R$ is compatible if $\forall x,y,v,w\in S: \; xRy \land vRw \implies (xv)R(yw)$.
\end{itemize}

\begin{proposition}
A relation $R$ on a semigroup $S$ is a congruence \textup{if and only if} it is a left and a right congruence.
\end{proposition}
\begin{proof}
($\Rightarrow$) If $R$ is a congruence, then $aRa$ by reflexivity. So $xRy$ implies $(ax)R(ay)$ and $(xa)R(ya)$, meaning that $R$ is a left and a right congruence.

($\Leftarrow$) Assume $R$ a left and a right congruence. Take $x,y,v,w$ such that $xRy$ and $vRw$. Then $(xv)R(yv)$ and $(yv)R(yw)$ by left and right compatibility. We conclude $(xv)R(yw)$ by transitivity.
\end{proof}

\subsection{Green's relations}
\begin{definition}
Let $\sSet{S,\cdot}$ be a semigroup. Let
\begin{itemize}
\item $\mathcal{L}$ be a relation on $S$ defined by $a\mathcal{L}b \defequiv \widetilde{S}a = \widetilde{S}b$;
\item $\mathcal{R}$ be a relation on $S$ defined by $a\mathcal{R}b \defequiv a\widetilde{S} = b\widetilde{S}$;
\item $\mathcal{H} \defeq \mathcal{L}\cap \mathcal{R}$;
\item $\mathcal{D} \defeq \mathcal{L}\vee \mathcal{R}$; TODO: which lattice?
\item $\mathcal{J}$ be a relation on $S$ defined by $a\mathcal{J}b \defequiv \widetilde{S}a\widetilde{S} = \widetilde{S}b\widetilde{S}$.
\end{itemize}
These five relations are known as \udef{Green's relations}.
\end{definition}

Clearly we have $\mathcal{D} \subseteq \mathcal{J}$.

\begin{lemma}
Let $\sSet{S,\cdot}$ be a semigroup and $a,b\in S$. Then
\begin{enumerate}
\item $a\mathcal{L}b$ \textup{if and only if} $\exists x,y\in \widetilde{S}: (xa = b) \land (yb = a)$;
\item $a\mathcal{R}b$ \textup{if and only if} $\exists x,y\in \widetilde{S}: (ax = b) \land (by = a)$;
\item $a\mathcal{J}b$ \textup{if and only if} $\exists x,y, u,v\in \widetilde{S}: (xay = b) \land (ubv = a)$.
\end{enumerate}
\end{lemma}
\begin{proof}
We prove (1), (2) is analogous.

($\Rightarrow$) $a\in \widetilde{S}a = \widetilde{S}b$, so there exists $y\in \widetilde{S}$ such that $a = yb$. The other equation is similar.

($\Leftarrow$) Because $\widetilde{S}x \subseteq \widetilde{S}$, we have $\widetilde{S}a \subseteq \widetilde{S}xa = \widetilde{S}b$. Similarly $\widetilde{S}b \subseteq \widetilde{S}a$.
\end{proof}
\begin{corollary}
$\mathcal{L}$ is a \emph{right} congruence and $\mathcal{R}$ a \emph{left} congruence.
\end{corollary}

\begin{proposition}
The relations $\mathcal{L}$ and $\mathcal{R}$ commute.
\end{proposition}
\begin{proof}
Assume $a(\mathcal{L};\mathcal{R})b$, meaning $\exists c: a\mathcal{L}c$ and $c\mathcal{R}b$. Then there exist $x,y,u,v\in \widetilde{S}$ such that
\[ (xa = c) \land (yc = a) \;\land\; (cu = b) \land (bv = c). \]
Now define $d = ycu$. Then $a\mathcal{R}d$ because
\[ d = (yc)u = au \;\text{and}\; a = yc = ybv = ycuv = dv \]
and $d\mathcal{L}b$ because
\[ d = ycu = yb \;\text{and}\; b = cu = xau = xycu = xd. \]
So $a(\mathcal{R};\mathcal{L})b$. The other inclusion is similar.
\end{proof}
\begin{corollary}
$\mathcal{D} = \mathcal{L};\mathcal{R} = \mathcal{R};\mathcal{L}$.
\end{corollary}
In other words, $a\mathcal{D}b \iff a\mathcal{L} \mesh \mathcal{R}b \iff a\mathcal{R} \mesh \mathcal{L}b$.

\begin{proposition}
Let $S$ be a periodic semigroup. Then $\mathcal{D} = \mathcal{J}$.
\end{proposition}
\begin{proof}
The inclusion $\mathcal{D} \subseteq \mathcal{J}$ is generally true. We want to prove the other inclusion.

Suppose $a\mathcal{J}b$. Then we can find $x,y,u,v\in \widetilde{S}$ such that
\[ xay = b, \quad ubv = a. \]
We see that $a = (ux)a(yu) = (ux)^2a(yu)^2 = \ldots$. By periodicity (TODO ref) we can find an $m\in \N$ such that $(ux)^m$ is idempotent. Then set $c= xa$, so that
\[ a = (ux)^ma(yu)^m = (ux)^m(ux)^ma(yu)^m = (ux)^ma = (ux)^{m-1}uc, \]
which means that $a\mathcal{L}c$.

Similarly we can choose $n\in \N$ such that $(vy)^n$ is idempotent, so from $b = (xu)b(vy) = (xu)^2b(vy)^2 = \ldots$
we get
\begin{align*}
c &= xa = x(ux)^{n+1}a(yu)^{n+1} = (xu)^{n+1}xay(vy)^nv \\
&= (xu)^{n+1}b(vy)^{2n}v = (xu)^{n+1}b(vy)^{n+1}(vy)^{n-1}v \\
&= b(vy)^{n-1}v.
\end{align*}
This along with $cy = xay = b$, gives $c\mathcal{R}b$. Thus $a\mathcal{L};\mathcal{R}b$, i.e.\ $a\mathcal{D}b$.
\end{proof}
\begin{corollary}
If the semigroup is finite, then $\mathcal{D} = \mathcal{J}$.
\end{corollary}

\begin{proposition}
Let $S$ be a semigroup. If $\sSet{S/\mathcal{L}, \subseteq}$ and $\sSet{S/\mathcal{R}, \subseteq}$ are well-founded, then $\mathcal{D} = \mathcal{J}$.
\end{proposition}
\begin{proof}
TODO
\end{proof}

\subsubsection{Egg-box diagrams}
\begin{definition}
In an \udef{egg-box diagram} a semigroup $S$ is depicted as a grid. Each element is put in this grid such that
\begin{itemize}
\item the rows are $\mathcal{R}$-classes; and
\item the columns are $\mathcal{L}$-classes.
\end{itemize} 
\end{definition}

Thus for $a,b\in S$, $[a]_\mathcal{L} = [b]_\mathcal{L}$ if and only if $a$ and $b$ are in the same column. Similarly, $[a]_\mathcal{R} = [b]_\mathcal{R}$ if and only if $a$ and $b$ are in the same row.

\begin{lemma}
Let $S$ be a semigroup and $a,b\in S$. Then
\begin{enumerate}
\item the cells in the egg-box diagram are $\mathcal{H}$-equivalence classes;
\item $a\mathcal{D}b$ \textup{if and only if} there is an element in the intersection of the row of $a$ and the column of $b$ or vice versa.
\end{enumerate}
\end{lemma}

\begin{example}
Consider the semigroup $(\{1,2,3\} \to \{1,2,3\})$ with composition $;$. We can represent an element $f$ of this semigroup as $(f(1) f(2) f(3))$. We have
\begin{itemize}
\item $f\mathcal{L}g$ if $f$ and $g$ have the same image;
\item $f\mathcal{R}g$ if $f$ and $g$ have the same kernel.
\end{itemize}
An egg-box diagram can be drawn as follows:
\[ \begin{array}{|c|c|c|c|c|c|c|}
\hline
\mathbf{(1 1 1)} & \mathbf{(2 2 2)} & \mathbf{(3 3 3)} &&& &  \\ \hline
&& & \mathbf{(1 2 2)}, & \mathbf{(1 3 3)}, & (2 3 3), &  \\
&& & (2 1 1)  & (3 1 1)  & (3 2 2)  &  \\ \hline
&& & (2 1 2), & (3 1 3), & \mathbf{(3 2 3)},  &  \\
&& & \mathbf{(1 2 1)}  & (1 3 1)  & (2 3 2)  &  \\ \hline
&& & (2 2 1), & (3 3 1), & (3 3 2),  &  \\
&& & (1 1 2)  & \mathbf{(1 1 3)}  & \mathbf{(2 2 3)}  &  \\ \hline
&& &&& & \mathbf{(1 2 3)}, (2 3 1) (3 1 2)  \\
&& &&& & (1 3 2), (2 1 3) (3 2 1)  \\ \hline
\end{array} \]
The bold elements are idempotents.
\end{example}


\begin{proposition}[Green's lemma] \label{GreensLemma}
Let $S$ be a semigroup and $a,b,x \in S$.
\begin{enumerate}
\item If $ax = b$ and $a\mathcal{R}b$, then
\begin{enumerate}
\item $\rho_x|_{[a]_\mathcal{L}}: [a]_\mathcal{L} \to [b]_\mathcal{L}$ is a bijection;
\item if $by = a$ for some $y\in \widetilde{S}$, then $\rho_y|_{[b]_\mathcal{L}}$ is the inverse;
\item $\rho_x|_{[a]_\mathcal{L}}$ preserves $\mathcal{R}$-classes.
\end{enumerate}
\item If $xa = b$ and $a\mathcal{L}b$, then
\begin{enumerate}
\item $\lambda_x|_{[a]_\mathcal{R}}: [a]_\mathcal{R} \to [b]_\mathcal{R}$ is a bijection with inverse $\lambda_y|_{[b]_\mathcal{R}}$;
\item if $yb = a$ for some $y\in \widetilde{S}$, then $\lambda_y|_{[b]_\mathcal{R}}$ is the inverse;
\item $\lambda_x|_{[a]_\mathcal{R}}$ preserves $\mathcal{L}$-classes.
\end{enumerate} 
\end{enumerate}
In particular
\begin{enumerate}
\item if $a\mathcal{R}b$, then there exists $x\in \widetilde{S}$ such that $ax = b$ and thus $|[a]_\mathcal{L}| = |[b]_\mathcal{L}|$;
\item if $a\mathcal{L}b$, then there exists $x\in \widetilde{S}$ such that $xa = b$ and thus $|[a]_\mathcal{R}| = |[b]_\mathcal{R}|$.
\end{enumerate}
\end{proposition}
\begin{proof}
The function $\rho_x$ is well-defined: let $u\in [a]_\mathcal{L}$ so that $u = va$ for some $v\in \widetilde{S}$. Then $\rho_x(u) = vax = vb \in [b]_\mathcal{L}$.

Because $a\mathcal{R}b$, we can always find a $y\in \widetilde{S}$ such that $by = a$. The function $\rho_y|_{[b]_\mathcal{L}}$ is clearly the inverse: $\rho_y(\rho_x(u)) = \rho_y(vb) = vby = va = u$. This shows that $\rho_x$ is bijective.

It is clear that $\rho_x$ preserves $\mathcal{R}$-classes, because it operates on the right.

The arguments for $\lambda_x$ and $\lambda_y$ are completely analogous.
\end{proof}
\begin{corollary}
Let $S$ be a semigroup and $a,b\in S$ such that $a\mathcal{D}b$, then $|[a]_\mathcal{H}| = |[b]_\mathcal{H}|$.
\end{corollary}
\begin{proof}
If $a(\mathcal{L};\mathcal{R})b$, then there exists a $c\in S$ such that $c = sa$ and $b = ct$. Then $\lambda_s\circ \rho_t$ is the required bijection.
\end{proof}

\begin{theorem}[Green's theorem]
Let $S$ be a semigroup and $H$ an $\mathcal{H}$-class in $S$. Then either
\begin{enumerate}
\item $H^2\perp H$; or
\item $H^2 = H$ and $H$ is a subgroup of $S$.
\end{enumerate}
\end{theorem}
\begin{proof}
Suppose $H^2\cap H \neq \emptyset$, then there exist $a,b\in H$ such that $ab = c\in H$. By the Green's lemma \ref{GreensLemma} we have that $\rho_b:H\to H$ and $\lambda_a: H\to H$ are bijections.

Then for all $h\in H$, $\rho_b(h) = hb \in H$. Again by the Green's lemma, this means that $\lambda_h: H\to H$ is a bijection. Similarly $\rho_h: H\to H$ is a bijection for all $h$. So for all $h\in H$ we have $hH = H = Hh$. This means $H^2 = H$ and $H$ is a group by \ref{groupCriterion}.
\end{proof}
\begin{corollary} \label{GreensTheoremCorollary}
Let $S$ be a semigroup and $H$ an $\mathcal{H}$-class in $S$. Then
\begin{enumerate}
\item if $x$ is an idempotent in $H$, then $H$ is a subgroup of $S$;
\item no $\mathcal{H}$-class can contain more than one idempotent. 
\end{enumerate}
\end{corollary}

\subsubsection{Regular elements $\mathcal{D}$-classes}
\begin{definition}
Let $S$ be a semigroup. An element $a\in S$ is called \udef{regular} if there exists $x\in S$ such that $axa = a$.
\end{definition}

\begin{proposition} 
Let $S$ be a semigroup. If $a\in S$ is regular, then every element in $[a]_{\mathcal{D}}$ is regular.
\end{proposition}
So it makes sense to call a $\mathcal{D}$-class \udef{regular} if it consists of regular elements and \udef{irregular} otherwise.
\begin{corollary}
If there is an idempotent $x\in [a]_{\mathcal{D}}$, then $[a]_{\mathcal{D}}$ is regular.
\end{corollary}
\begin{proof}
An idempotent is regular: $x = xx = x(xx) = xxx$.
\end{proof}

\begin{proposition} \label{idempotentsInGreensClasses}
Let $S$ be a semigroup.
\begin{enumerate}
\item If $x\in S$ is an idempotent, then $x$ is a left identity for $[x]_{\mathcal{R}}$ and $x$ is a right identity for $[x]_{\mathcal{L}}$.
\item If $a$ is regular with $axa = a$, then $xa$ and $ax$ are idempotents.
\item If $a$ is regular with $axa = a$, then $xa\mathcal{L}a$ and $ax\mathcal{R}a$.
\item In a regular $\mathcal{D}$-class each $\mathcal{L}$-class and each $\mathcal{R}$-class contains at least one idempotent.
\end{enumerate}
\end{proposition}
\begin{proof}
(1) Let $a\in [x]_\mathcal{R}$. Then there exists a $y\in \widetilde{S}$ such that $a = xy$ and thus $xa = xxy = xy = a$. The claim of right-identity is similar.

(2) We have $(xa)(xa) = x(axa) = xa$ and $(ax)(ax) = (axa)x = ax$.

(3) If $a$ is regular with $axa = a$, then $xa$ is idempotent: $(xa)(xa) = x(axa) = xa$ and $xa \in [a]_{\mathcal{L}}$:
\[ xa = (xa) \qquad a(xa) = a \]
Similarly $ax \in [a]_{\mathcal{R}}$ and is idempotent.

(4) Let $[a]_\mathcal{L}$ be an $\mathcal{L}$-class in a regular $\mathcal{D}$-class. By regularity there exists an $x\in S$ such that $axa = a$. From (2) and (3), we have that $[a]_\mathcal{L}$ contains the idempotent $xa$ and $[a]_\mathcal{R}$ the idempotent $ax$.
\end{proof}

\begin{proposition}
Let $a,b \in S$ such that $a\mathcal{D}b$. Then $ab\in [a]_{\mathcal{R}}\cap [b]_{\mathcal{L}}$ \textup{if and only if} $[b]_{\mathcal{R}}\cap [a]_{\mathcal{L}}$ contains an idempotent.
\end{proposition}
\begin{proof}
Suppose $[b]_{\mathcal{R}}\cap [a]_{\mathcal{L}}$ contains an idempotent $x$. Then $xb = b$ by \ref{idempotentsInGreensClasses}. Then $\rho_b$ maps $[x]_{\mathcal{L}} = [a]_{\mathcal{L}}$ to $[b]_{\mathcal{L}}$ by \ref{GreensLemma}. It preserves $\mathcal{R}$-classes, so in particular it maps $[a]_{\mathcal{H}}$ to $[a]_{\mathcal{R}}\cap [b]_{\mathcal{L}}$. Thus $ab = \rho_b(a) \in [a]_{\mathcal{R}}\cap [b]_{\mathcal{L}}$.

Now assume $ab\in [a]_{\mathcal{R}}\cap [b]_{\mathcal{L}}$. Then there exists a $c\in \widetilde{S}$ such that $abc = a$. By \ref{GreensLemma} this means $\rho_c\in ([ab]_{\mathcal{L}}\to [a]_{\mathcal{L}}) = ([b]_{\mathcal{L}}\to [a]_{\mathcal{L}})$. In particular this restricts to $([b]_{\mathcal{H}}\to [b]_{\mathcal{R}}\cap[a]_{\mathcal{L}})$. Because $ab = (ab)$, $\rho_b$ is the inverse of $\rho_c$ by the same lemma.

So $\rho_c(b) = bc \in [b]_{\mathcal{R}}\cap[a]_{\mathcal{L}}$ and bc is idempotent because
\[ bcbc = (\rho_c\circ\rho_b\circ\rho_c) (b) = \rho_c(b) = bc. \]
\end{proof}

\subsubsection{Generalised inverses}
\begin{definition}
Let $S$ be a semigroup and $a\in S$. We call $a'$ a \udef{(generalised) inverse} of $a$ if
\[ aa'a = a, \qquad a'aa' = a'. \]
\end{definition}

\begin{lemma}
Let $S$ be a semigroup and $a\in S$. Then $a$ has a generalised inverse \textup{if and only if} it is regular.
\end{lemma}
\begin{proof}
Clearly every element with a generalised inverse is regular. Conversely, assume $a$ regular with $axa = a$. Then $a' = xax$ is a generalised inverse of $a$.
\end{proof}

\begin{proposition} \label{inversesIdempotentsDclass}
Let $a$ be an element of a regular $\mathcal{D}$-class $D$ in a semigroup $S$.
\begin{enumerate}
\item If $a'$ is a generalised inverse of $a$, then
\begin{enumerate}
\item $a' \in D$;
\item $[aa']_\mathcal{H} = [a]_\mathcal{R}\cap [a']_\mathcal{L}$;
\item $[a'a]_\mathcal{H} = [a']_\mathcal{R}\cap [a]_\mathcal{L}$.
\end{enumerate}
\item If $b\in S$ is such that $[a]_\mathcal{R}\cap [b]_\mathcal{L}$ contains an idempotent $x$ and $[b]_\mathcal{R}\cap [a]_\mathcal{L}$ contains an idempotent $y$, then $[b]_\mathcal{H}$ contains a generalised inverse $a'$ of $a$ such that $aa' = x$ and $a'a = y$.
\item No $\mathcal{H}$-class contains more than one generalised inverse of $a$.
\end{enumerate}
\end{proposition}
\begin{proof}
(1) Firstly notice that $[a]_\mathcal{R}\cap [a']_\mathcal{L}$ is an $\mathcal{H}$-class. Also $a\mathcal{R}aa'$ and $a'\mathcal{L}aa'$ by \ref{idempotentsInGreensClasses}.

(2) From $a\mathcal{R}x$, we deduce that there exists a $u\in\widetilde{S}$ such that $au = x$. 

Set $a' = yux$. Then, using that $x$ is a left-identity on $[a]_\mathcal{R}$ and $y$ a right-identity on $[a]_\mathcal{L}$ by \ref{idempotentsInGreensClasses},
\begin{align*}
aa'a &= a(yux)a = (ay)u(xa) = aua = (au)a = xa = a \\
a'aa' &= (yux)a(yux) = (yu)(xay)(ux) = (yu)a(ux) = (yu)(au)x = yux^2 = yux = a' \\
aa' &= a(yux) = ((ay)u)x = (au)x = x^2 = x.
\end{align*}
For the last equality, we need that $a\mathcal{L}y$ implies the existence of $v\in \widetilde{S}$ such that $va = y$. Then
\[ a'a = (yux)a = (va)u(xa) = (va)(ua) = v(au)a = v(xa) = va = y. \]
We now just need to show that $a' \in [b]_\mathcal{H}$. By \ref{idempotentsInGreensClasses} we have $a'\in [aa']_{\mathcal{L}}$ and $a'\in [a'a]_{\mathcal{R}}$, so
\[ a' \in [aa']_{\mathcal{L}} \cap [a'a]_{\mathcal{R}} = [x]_{\mathcal{L}} \cap [y]_{\mathcal{R}} = [b]_{\mathcal{L}} \cap [b]_{\mathcal{R}} = [b]_\mathcal{H}. \]

(3) Suppose $[b]_\mathcal{H}$ is an $\mathcal{H}$-class containing two generalised inverses $a_1', a_2'$ of $a$. Then $aa'_1 = aa'_2$ and $a'_1a = a'_2a$ by \ref{GreensTheoremCorollary} and thus
\[ a'_1 = a'_1(aa'_1) = a'_1(aa'_2) = (a'_2a)a'_2 = a'_2. \]
\end{proof}
\begin{corollary} \label{corollaryInversesIdempotentsDclass}
Let $S$ be a semigroup and $x,y\in S$ idempotents. Then $x\mathcal{D}y$ \textup{if and only if} we can write $x = aa'$ and $y = a'a$ for some $a\in [x]_\mathcal{R}\cap [y]_\mathcal{L}$ and $a'\in [y]_\mathcal{R}\cap [x]_\mathcal{L}$ that are generalised inverses of each other.
\end{corollary}
\begin{proof}
We have $x\mathcal{D}y$ iff there exist $a,b\in S$ such that $x\mathcal{R}a$, $a\mathcal{L}y$ and $x\mathcal{L}b$, $b\mathcal{R}y$. This means $x\in [a]_\mathcal{R}\cap [b]_\mathcal{L}$ and $y\in [b]_\mathcal{R}\cap [a]_\mathcal{L}$. So by the proposition we can find an $a'\in [b]_\mathcal{H}$ that satisfies the requirements.
\end{proof}

\begin{proposition}
Let $S$ be a semigroup and let $H,K$ be $\mathcal{H}$-classes that are subgroups and members of the same $\mathcal{D}$-class. Then $H$ and $K$ are isomorphic groups.
\end{proposition}
\begin{proof}
Let $e$ be the idempotent (and thus identity) in $H$ and $f$ the identity in $K$. By \ref{corollaryInversesIdempotentsDclass} we have mutually inverse $a\in [x]_\mathcal{R}\cap [y]_\mathcal{L}$ and $a'\in [y]_\mathcal{R}\cap [x]_\mathcal{L}$ such that $x = aa'$ and $y = a'a$.

We claim $\lambda_{a'}\circ\rho_{a}|_H$ is an isomorphism $H\to K$. Indeed it is bijective by \ref{GreensLemma}. We need to show that it is a homomorphism: take $u,v\in H$
\[ (\lambda_{a'}\circ\rho_{a})(u)(\lambda_{a'}\circ\rho_{a})(v) = a'uaa'va = a'uxva = a'uva = (\lambda_{a'}\circ\rho_{a})(uv), \]
where we have used that $x$ is the identity for $H$.
\end{proof}

\subsubsection{Regular semigroups}
\begin{definition}
A regular semigroup is a semigroup where every element is regular.
\end{definition}

\begin{lemma}
Let $S$ be a regular semigroup. Then for all $a\in S$
\[ \widetilde{S}a = Sa, \qquad  a\widetilde{S} = aS \qquad\text{and}\qquad \widetilde{S}a\widetilde{S} = SaS. \]
\end{lemma}
So we can drop all mention of $\widetilde{S}$ when working with ideal. In particular
\begin{itemize}
\item $a\mathcal{L}b$ if and only if $Sa = Sb$;
\item $a\mathcal{R}b$ if and only if $aS = bS$;
\item $a\mathcal{J}b$ if and only if $SaS = SbS$.
\end{itemize}

\subsection{Inverse semigroups}

\section{Monoids}


\begin{lemma}
A locally small category with a single object is a monoid.
\end{lemma}
TODO: \udef{delooping} $\cat{B}M$.


\subsection{Ordered monoids}
\begin{definition}
An \udef{ordered monoid} is a monoid $(M, \cdot, 0)$ on which a partial order $\preceq$ is defined that is compatible, i.e.\ $\forall x,y,z\in M$
\[ x\preceq y \implies x\cdot z \preceq y \cdot z \land z\cdot x \preceq z \cdot y. \]

Positive: $x > 0$.
\end{definition}

\subsubsection{The Archimedean property}
\begin{definition}
Let $(M,+,\leq)$ be a totally ordered monoid and $x,y\in M$ positive. Then
\begin{itemize}
\item $x$ is \udef{infinitesimal w.r.t.} $y$ or $y$ is \udef{infinite w.r.t.} $x$ if $nx<y$ for all $n\in\N$;
\item $M$ is \udef{Archimedean} if there is no pair $(x,y)$ such that $x$ is infinitesimal w.r.t. $y$.
\end{itemize}
\end{definition}
every submonoid is Archimedean.

abelian??

\subsubsection{Regular ordering for commutative monoids}
\begin{definition}
Let $\sSet{M,+,0}$ be a commutative monoid. Consider the function $m: \powerset(M\to M) \to \powerset(X^2)$ from \ref{setOfFunctionsToRelationGaloisConnection}. (TODO define higher).

The \udef{regular order} on $M$ is $m\setbuilder{\lambda_a}{a\in M}$.
\end{definition}

\begin{lemma}
The regular order is a preorder on $M$ that is compatible with $M$. It is a partial order \textup{if and only if} $M$ is cancellative.
\end{lemma}

\begin{example}
The regular order on $\N$ is the standard order on $\N$.
\end{example}

\section{Divisibility}
$m|n$ order relation.

$\sup\{n,m\} = kgv(n,m)$ and $\inf\{n,m\} = ggd(n,m)$



\chapter{Relational structures}
\begin{definition}
A \udef{relational structure} is a structured set $\sSet{A, R}$ where $R$ is a homogeneous relation on the set $A$.
\end{definition}


\section{Duality}
\begin{definition}
Let $\sSet{A,R}$ be a relational structure.

The relational structure \udef{dual} to $\sSet{A,R}$ is $\sSet{A, R}^o \defeq \sSet{A^o,R^\transp}\defeq \sSet{A,R^\transp}$.
\end{definition}



\section{Functions on relational structures}

\begin{lemma} \label{functionSubsetRelation}
Let $f: A\to A$ be a function on a relational structure $\sSet{A,R}$. Then
\[ f \subseteq R \iff \id_A \subseteq R;f^\transp. \]
\end{lemma}
\begin{proof}
We have
\[ f \subseteq R \implies \id_A \subseteq f;f^\transp \subseteq R;f^\transp \implies f \subseteq R;f^\transp;f \subseteq R. \]
\end{proof}

\begin{definition}
Let $(A, R)$ and $(B, S)$ be relational structures and $f: A\to B$ a function. We say
\begin{itemize}
\item $f$ is \udef{relation-preserving} if
\[ \forall x,y\in A: xRy \implies f(x)Sf(y); \]
\item $f$ is \udef{relation-reflecting} if
\[ \forall x,y\in A: f(x)Sf(y) \implies xRy; \]
\item $f$ is a \udef{relation embedding} if it is relation-preserving and -reflecting:
\[ \forall x,y\in A: xRy \iff f(x)Sf(y). \]
\end{itemize}
\end{definition}

\begin{proposition} \label{relationPreserving}
Let $\sSet{X, R}$ and $\sSet{Y, S}$ be relational structures and $f: X\to Y$ a function. Then the following are equivalent:
\begin{enumerate}
\item $f$ is relation-preserving;
\item $R \subseteq f;S;f^\transp$;
\item $R;f \subseteq f;S$.
\end{enumerate}
\end{proposition}
\begin{proof}
$(1) \Leftrightarrow (2)$ Is clear from the definition.

$(2) \Rightarrow (3)$ We calculate
\[ R;f \subseteq (f;S;f^\transp);f = f;S;(f^\transp;f) \subseteq f;S;\id = f;S. \]

$(3) \Rightarrow (2)$ We calculate
\[ R \subseteq R;(f;f^\transp) = (R;f);f^\transp \subseteq f;S;f^\transp. \]
\end{proof}
\begin{corollary}
Let $\sSet{X, R}$ and $\sSet{Y, S}$ be relational structures and $f: X\to Y$ a function. Then the following are also equivalent to $f$ being relation-preserving:
\begin{enumerate}
\item $f: X^o \to Y^o$ is relation preserving;
\item $R^\transp \subseteq f;S^\transp;f^\transp$;
\item $R^\transp;f \subseteq f;S^\transp$;
\item $f^\transp;R \subseteq S;f^\transp$.
\end{enumerate}
\end{corollary}
\begin{proof}
(2) Is equivalent to $R \subseteq f;S;f^\transp$ by taking the transpose. The equivalence of (1), (2) and (3) is then given by the proposition.

(4) Is equivalent to (3) by taking the transpose.
\end{proof}
\begin{corollary} \label{functionImagesPreimagesAndPrincipalImages}
Let $\sSet{A,R}$ and $\sSet{B, S}$ be relational structures and $f: A\to B$ a function. Then the following are equivalent:
\begin{enumerate}
\item $f$ is order-preserving;
\item for all $X\subseteq A$: $f[X_R] \subseteq f[X]_S$;
\item for all $x\in A$: $f[xR] \subseteq f(x)S$.
\end{enumerate}
They are also equivalent to:
\begin{enumerate} \setcounter{enumi}{3}
\item for all $Y\subseteq B$: $f^{-1}[Y]_R \subseteq f^{-1}[Y_S]$
\item for all $y\in B$: $f^{-1}[\{y\}]_R \subseteq f^{-1}[yS]$.
\end{enumerate}
\end{corollary}
TODO: this implies $R$-closure for $f^{-1}$: by preservation of union we have $f^{-1}[yS]_R \subseteq f^{-1}[yS^2] = f^{-1}[yS]$.
\begin{proof}
$(1 \Leftrightarrow 2)$ Follows by taking images of $X$ under $R;f \subseteq f;S$ and the fact that relations are completely determined by their images.

$(2 \Leftrightarrow 3)$ This is the particular case of principal images. A relation is completely characterised by its principal images. See \ref{relationFromPrincipalImages}.

$(4, 5)$ Here we are taking images of $f^\transp;R \subseteq S;f^\transp$.
\end{proof}
\begin{note}
Useful exercise: give elementary proof of \ref{functionImagesPreimagesAndPrincipalImages}. This can be based on the calculations
\[ y\in xR \iff xRy \implies f(x)Rf(y) \iff f(y) \in f(x)R \]
and
\begin{align*}
x\in f^{-1}[\{y\}]_R &\iff \exists z:\; f(z) = y \;\land\; zRx \\
&\implies \exists z:\; f(z) = y \;\land\; f(z)Rf(x) \\
&\implies ySf(x) \iff f(x) \in yS \iff x\in f^{-1}[yS].
\end{align*}
\end{note}

\begin{lemma}
Let $(A, R)$ and $(B, S)$ be relational structures and $f: A\to B$ a function. Then
\begin{enumerate}
\item $f$ is relation-reflecting \textup{if and only if} $R \supseteq f;S;f^\transp$;
\item $f$ is a relation embedding \textup{if and only if} $R = f;S;f^\transp$.
\end{enumerate}
\end{lemma}

\begin{lemma} \label{connexityImage}
Let $f: \sSet{X,R} \to \sSet{Y,S}$ be a relation preserving function. If $X$ is connex, then so is $\imf(f)$.
\end{lemma}

\begin{definition}
A function $f: A\to A$ on a relational structure $\sSet{A, R}$ is
\begin{itemize}
\item \udef{left-restrictive} if $f;R \subseteq R$;
\item \udef{right-restrictive} if $R;f^\transp \subseteq R$;
\item \udef{left-expansive} if $R \subseteq f;R$;
\item \udef{right-expansive} if $R \subseteq R;f^\transp$.
\end{itemize}
\end{definition}

TODO: expansive, contractive, extensive.

\begin{lemma} \label{transitiveRestrictiveLemma}
Let $f: A\to B$ be a function and $R$ a transitive relation on $B$. Then $f\subseteq R$ implies $f;R\subseteq R$ and $R;f\subseteq R$.
\end{lemma}
\begin{proof}
We have $f;R\subseteq R^2 \subseteq R$ and $R;f \subseteq R^2 \subseteq R$.
\end{proof}

\begin{lemma} \label{expansiveRelationPreserving}
Let $f: \sSet{A,R} \to \sSet{A,R}$ be a relation-preserving function. Then
\[ f;R \subseteq R \implies R \subseteq R;f^\transp \]
\end{lemma}
\begin{proof}
We calculate
\[ R \subseteq f;R;f^\transp \subseteq R;f^\transp. \]
\end{proof}

\subsection{Relation isomorphisms}
\begin{definition}
Let $(A_1, R_1)$ and $(A_2, R_2)$ be relational structures. A bijection $\phi:A_1 \twoheadrightarrowtail A_2$ such that
\[ \forall (s_1,t_1)\in R_1: (\phi(s_1),\phi(t_1))\in R_2 \qquad \text{and} \qquad \forall (s_2,t_2)\in R_2: (\phi^{-1}(s_2),\phi^{-1}(t_2))\in R_1, \]
is called a \udef{(relation) isomorphism}. If there exists a relation isomorphism $A_1 \twoheadrightarrowtail A_2$, then $(A_1, R_1)$ and $(A_2, R_2)$ are \udef{isomorphic}, denoted $A_1 \cong A_2$.
\end{definition}

\begin{lemma}
A map is a relation isomorphism \textup{if and only if} it is a bijective relation embedding.
\end{lemma}
\begin{proof}
Let $f: \sSet{A, R}\to \sSet{B, }$ be a bijective map. Then $f$ is relation-reflecting iff $f^{-1}$ is relation-preserving. Indeed
\[ f;R;f^{-1} \subseteq R \iff R = f^{-1};f;R;f^{-1};f \subseteq f^{-1};R;f. \]
\end{proof}

\begin{lemma} \label{isomorphismEquivalence}
Let $(A_1, R_1)$, $(A_2, R_2)$ and $(A_3, R_3)$ be relational structures and $f:A_1 \twoheadrightarrowtail A_2$, $g:A_2 \twoheadrightarrowtail A_3$ isomorphisms. Then
\begin{enumerate}
\item $I_{A_1}: A_1 \to A_1: a\mapsto a$ is an isomorphism;
\item $f^{-1}: A_2\to A_1$ is an isomorphism;
\item $(g\circ f): A_1\to A_3$ is an isomorphism.
\end{enumerate}
\end{lemma}
Consequently, relation isomorphism would be an equivalence relation on all structured sets, except there is no set of all structured sets, by Russell's paradox. Relation isomorphism can be an equivalence relation on a (restricted) set of structured sets.

\begin{lemma}
Let $(A_1, R_1)$ and $(A_2, R_2)$ be isomorphic relational structures. Then $R_1$ has the same properties as $R_2$.
\end{lemma}
e.g\: reflexivity, symmetry, transitivity, being an equivalence relation etc.


\section{The semigroup of relation-preserving functions}
\begin{lemma}
Let $\{\sSet{A_i, R_i}\}_{i\in I}$ be a set of relational structures. Then the set of relation-preserving functions together with $\emptyset$ forms a semigroup under composition.
\end{lemma}


TODO: Full semigroup, i.e.\ if relational structure is involved, all morphisms must be present.
\begin{proposition}
Let $M$ be a semigroup of relation-preserving functions and $f: \sSet{A, R} \to \sSet{B,S}$, $g: \sSet{A, R} \to \sSet{C,T}$ relation-preserving functions. Then
\[ f\mathcal{R}g \iff (f;S;f^\transp = g;T;g^\transp)\land (\ker f = \ker g). \]
\end{proposition}
\begin{proof}
First assume $f\mathcal{R}g$, then there exist $x,y\in \tilde{M}$ such that $f = g;x$ and $g = f;y$. Now $x$ and $y$ are relation preserving: $T \subseteq x;S;x^\transp$ and $S \subseteq y;T;y^\transp$. So
\[ f;S;f^\transp = g;x;S;x^\transp;g^\transp \supseteq g;T;g^\transp \quad\text{and}\quad g;T;g^\transp = f;y;T;y^\transp;f^\transp  \supseteq f;S;f^\transp. \]

For the converse, we can find functions $x,y$ such that $f = g;x$ and $g = f;y$ because of the equality of the kernels. We just need to show that $x$ and $y$ are relation-preserving. Because $g^\transp;f = g^\transp;g;x \subseteq x$, we have
\[ T \subseteq g^\transp;g;T;g^\transp;g = g^\transp;f;S;f^\transp;g \subseteq x;S;x^\transp. \]
The argument for $y$ is similar.
\end{proof}
\begin{corollary} \label{relationPreservingGeneralisedInversesEmbeddings}
Let $a,a'$ be generalised inverses in the semigroup of relation-preserving functions. Then
\begin{enumerate}
\item $aa'R a^{\prime\transp} = aSa^\transp a^{\prime\transp}$;
\item $a'R a^{\prime\transp}a^\transp = a'aSa^\transp$;
\item $a|_{\im a'}$ and $a'|_{\im a}$ are relation embeddings.
\end{enumerate}
\end{corollary}
\begin{proof}
Let $a: \sSet{A,R} \to \sSet{B,S}$ and $a': \sSet{B,S} \to \sSet{A,R}$ be generalised inverses. From \ref{idempotentsInGreensClasses} we have $a\mathcal{R}aa'$ and $a'\mathcal{R}a'a$. The proposition then gives us $aSa^\transp = aa'Ra^{\prime\transp} a^\transp$.

(1) Multiplying this equality on the right by $a^{\prime\transp}$ and using $a^{\prime\transp} = (a'aa')^\transp = a^{\prime\transp} a^\transp a^{\prime\transp}$ gives us
\[ aSa^\transp a^{\prime\transp} = aa'R(a^{\prime\transp} a^\transp a^{\prime\transp}) = aa'Ra^{\prime\transp}. \]

(2) Similar to (1), except multiplying on the left by $a'$.

(3) By assumption $a$ and $a'$ are relation-preserving. Also, using $aSa^\transp = aa'Ra^{\prime\transp} a^\transp$, we have
\[ S \supseteq S|_{\im(a)}^{\im(a)} = a^\transp aSa^\transp a = a^\transp (aa'Ra^{\prime\transp} a^\transp) a = (a^\transp a)a'Ra^{\prime\transp} (a^\transp a) = a'|_{\im(a)}R(a'|_{\im(a)})^{\transp}. \]
This means that $a'|_{\im(a)}$ is also relation-reflecting. The argument for $a|_{\im(a')}$ is similar.
\end{proof}


\subsection{Galois connections}
\begin{definition}
Let $a: \sSet{A,R} \to \sSet{B,S}$ and $a': \sSet{B,S} \to \sSet{A,R}$ be relation-preserving generalised inverses. We say $(a,a')$ is a \udef{Galois connection} between $\sSet{A, R}$ and $\sSet{B, S}$ if
\begin{itemize}
\item $aa'$ is left-restrictive for $R$, i.e.\ $aa'R \subseteq R$; and
\item $a'a$ is left-restrictive for $S^\transp$, i.e.\ $a'aS^\transp \subseteq S^\transp$.
\end{itemize}
We call $a$ the \udef{lower adjoint} or \udef{residuated map} and $a'$ the \udef{upper adjoint} or \udef{residual}.

Sometimes a Galois connection between $\sSet{A, R}$ and $\sSet{B, S}^o$ is referred to as an \udef{antitone Galois connection} between $\sSet{A, R}$ and $\sSet{B, S}$. In this situation we may refer to the ordinary Galois connection as a \udef{monotone Galois connection} to highlight the difference.
\end{definition}
Some authors exclusively use the term ``Galois connection'' to refer to antitone Galois connections. They my call monotone Galois connections residuated mappings.

\begin{lemma}
Let $\sSet{A, R}$ and $\sSet{B, S}$ be relational structures, and $a: \sSet{A,R} \to \sSet{B,S}$ and $a': \sSet{B,S} \to \sSet{A,R}$ functions. Then $(a,a')$ is an antitone Galois connection \textup{if and only if}
\begin{enumerate}
\item $a, a'$ are relation-reversing;
\item $a, a'$ are generalised inverses;
\item $aa'R \subseteq R$ and $a'aS \subseteq S$.
\end{enumerate}
\end{lemma}

For any relation-preserving involution $f: \sSet{A,R} \to \sSet{A,R}$,  $(f,f)$ is a Galois connection. For any relation-reversing involution $f: A\to A$, $(f,f^o)$ is a Galois connection between $\sSet{A,R}$ and $\sSet{A,R}^o$, where we consider $f$ as a function $f: \sSet{A,R} \to \sSet{A,R}^o$ and $f^o$ as the function $f^o: \sSet{A,R}^o \to \sSet{A,R}$ with the same graph.

\begin{example}
\begin{itemize}
\item Let $\sSet{A, \id_A}$ and $\sSet{B, \id_B}$ be discrete relational structures. Then $f: A\to B$ and $g: B \to A$ form a Galois connection if and only if they are invertible and $f = g^{-1}$.
\item Let $A$ be a set. Then complementation $c: \powerset(A) \to \powerset(A)$ is a relation-reversing involution, so it gives a Galois connection between $\sSet{\powerset(A), \subseteq}$ and $\sSet{\powerset(A), \subseteq}^o$. In particular we have the identity
\[ \forall X, Y\in\powerset(A): \qquad X^c \subseteq Y \iff X \supseteq Y^c, \]
which is the Galois identity \ref{GaloisIdentity}.
\end{itemize}
\end{example}

\begin{lemma} \label{immediateGaloisCorollaries}
If $(a,a')$ is a Galois connection between $\sSet{A,R}$ and $\sSet{B,S}$, then
\begin{enumerate}
\item $R^\transp \subseteq aa'R^\transp$ and $S \subseteq a'aS$;
\item $Raa' \subseteq R$ and $S^\transp a'a \subseteq S^\transp$.
\end{enumerate}
\end{lemma}
\begin{proof}
(1) This is a direct application of \ref{expansiveRelationPreserving}. I can also be obtained as a corollary to \ref{GaloisIdentity} (later).

(2) Follows from the Galois condition and the fact $a'a, aa'$ are relation-preserving (\ref{relationPreserving}):
\[ Raa' \subseteq aa'R \subseteq R \qquad\text{and}\qquad S^\transp a'a \subseteq a'aS^\transp \subseteq S^\transp. \]
\end{proof}

In particular, if the relations are reflexive, we have
\[ \id_A \subseteq R^\transp \subseteq aa'R^\transp \qquad\text{and}\qquad \id_B \subseteq S \subseteq a'aS. \]
This means that for all $x\in A$ we have $ xRa'(a(x))$ and for all $y\in B$ we have $a(a'(y))Sy$.

\subsubsection{The Galois identity}
\begin{proposition} \label{GaloisIdentity}
If $(a,a')$ is a Galois connection between $\sSet{A,R}$ and $\sSet{B,S}$, then
\[ aS = Ra^{\prime \transp}. \]
\end{proposition}
This identity is particularly important because it gives also gives a sufficient condition for a pair of maps between preorders to be a Galois connection, see \ref{preorderGaloisIdentity}.
\begin{proof}
By \ref{relationPreservingGeneralisedInversesEmbeddings} we have $aa'R a^{\prime\transp} = aSa^\transp a^{\prime\transp}$. Because $a,a'$ are relation-preserving, we have
\[ aS \subseteq aa'R a^{\prime\transp} = aSa^\transp a^{\prime\transp} = aS(a'a)^\transp \subseteq aS \quad\text{and}\quad Ra^{\prime\transp} \subseteq aSa^\transp a^{\prime\transp} = aa'R a^{\prime\transp} \subseteq Ra^{\prime\transp}, \]
which implies $aS = aSa^\transp a^{\prime\transp} = aa'R a^{\prime\transp} = Ra^{\prime\transp}$.
\end{proof}
\begin{corollary} \label{reflexiveGaloisCorollary}
Let $(a,a')$ be a Galois connection between $\sSet{A,R}$ and $\sSet{B,S}$.
\begin{enumerate}
\item If $S$ is reflexive, then $aa' \subseteq R$.
\item If $R$ is reflexive, then $a'a \subseteq S^\transp$.
\end{enumerate}
\end{corollary}
We can reformulate (1) as $xR(a'\circ a)(x)$ for all $x\in A$ and (2) as $yS(a\circ a')(y)$ for all $y\in B$.
\begin{proof}
(1) We calculate $aa' \subseteq aSa' = Ra^{\prime \transp}a' \subseteq R$.

(2) Similarly, $a'a \subseteq a'R^\transp a = S^\transp a^\transp a \subseteq S^\transp$.
\end{proof}

\begin{lemma} \label{preimagesGaloisIdentity}
Let $\sSet{A, R}$ and $\sSet{B, S}$ be relationals structures and $f: A\to B$, $g: B\to A$ functions.
The following are equivalent:
\begin{enumerate}
\item $f;S = R;g^\transp$;
\item for all $x$: $f(x)S = g^{-1}[xR]$;
\item for all $y$: $f^{-1}[Sy] = Rg(y)$.
\end{enumerate}
\end{lemma}
\begin{proof}
Relations are completely characterised by their principal images / preimages. See \ref{relationFromPrincipalImages}.
\end{proof}

\begin{proposition} \label{preorderGaloisCondition}
Let $a: \sSet{A,R} \to \sSet{B,S}$ and $a': \sSet{B,S} \to \sSet{A,R}$ be order-preserving generalised inverses on preorders. Then the following are equivalent:
\begin{enumerate}
\item $(a, a')$ is a Galois connection;
\item $aa' \subseteq R$ and $a'a \subseteq S^\transp$;
\item $\id_A \subseteq aa'R^\transp$ and $\id_B \subseteq a'aS$.
\end{enumerate}
If the orders are partial orders, then we do not need the additional assumption that $a, a'$ are generalised inverses.
\end{proposition}
\begin{proof}
$(1) \Rightarrow (2)$ is given by \ref{reflexiveGaloisCorollary}.

$(2) \Rightarrow (1)$ follows by transitivity, see \ref{transitiveRestrictiveLemma}.

$(2) \Leftrightarrow (3)$ is given by \ref{functionSubsetRelation}.

Now assume the orders are anti-symmetric. We need to show that $(2,3)$ imply that $a, a'$ are generalised inverses. First, by transitivity, we have
\[ R^\transp \subseteq aa'(R^2)^\transp \subseteq aa'R^\transp \qquad\text{and}\qquad S \subseteq a'aS^2 \subseteq a'aS. \]
Then, using the fact that $a$ and $a'$ are relation preserving,
\begin{align*}
\id &\subseteq R \subseteq aSa^\transp \subseteq aa'aSa^\transp \\
\id &\subseteq R^\transp \subseteq aa'R^\transp \subseteq aa'aS^\transp a^{\transp} \\
\id &\subseteq S \subseteq a'aS \subseteq a'aa'Ra^{\prime\transp} \\
\id &\subseteq S^\transp \subseteq a'R^\transp a^{\prime\transp} \subseteq a'aa'R^\transp a^{\prime\transp}.
\end{align*}
By anti-symmetry, we have
\[ \id \subseteq a'aa'(R\cap R^\transp)a^{\prime\transp} \subseteq a'aa'a^{\prime\transp} \qquad\text{and}\qquad \id \subseteq  aa'a(S\cap S^\transp)a^\transp \subseteq aa'aa^\transp. \]
Finally \ref{functionEqualityIdComparison} gives $a = aa'a$ and $a' = a'aa'$.
\end{proof}

\begin{proposition} \label{preorderGaloisIdentity}
Let $\sSet{A,R}$ and $\sSet{B,S}$ be preorders. Let $a: A\to B$ and $a': B\to A$ be functions. If $a,a'$ are generalised inverses and
\[ aS = Ra^{\prime \transp}, \]
then $(a, a')$ is a Galois connection.

If $\sSet{A,R}$ and $\sSet{B,S}$ are partial orders, then the assumption of generalised inverses is superfluous. 
\end{proposition}
So the identity $aS = Ra^{\prime \transp}$ is sufficient for two functions $a,a'$ between posets to form a Galois connection. Indeed this is often taken as the definition of a Galois connection for posets.
\begin{proof}
We need to prove that $a,a'$ are order-preserving, generalised inverses and that $aa', a'a$ are properly restrictive.

We first verify restrictivity. By reflexivity we have
\[ aa' \subseteq aSa' = Ra^{\prime \transp}a' \subseteq R \qquad\text{and}\qquad a'a \subseteq a'R^\transp a = S^\transp a^\transp a \subseteq S^\transp. \]
By \ref{transitiveRestrictiveLemma} $aa'$ and $a'a$ are properly restrictive.

Next we prove order-preservation $aa'\subseteq R$. We first prove the identities of \ref{expansiveRelationPreserving}:
\[ R^\transp \subseteq aa'(aa')^\transp R^\transp \subseteq aa'R^\transp (aa')^\transp R^\transp = aa' (aa'R)^\transp R^\transp \subseteq aa'R^\transp R^\transp = aa'R^\transp \]
\[ S \subseteq a'a(a'a)^\transp S \subseteq a'a S (a'a)^\transp S = a'a(a'aS^\transp)^\transp S \subseteq a'a(S^\transp)^\transp S = a'aS. \]
From this relation-preservation follows easily:
\[ R \subseteq R(aa')^\transp = (Ra^{\prime \transp})a^\transp = aSa^\transp \qquad\text{and}\qquad S \subseteq a'aS = a'(aS) = a'Ra^{\prime \transp}. \]

Finally, assuming $R,S$ are anti-symmetric, then $a, a'$ are generalised inverses by \ref{preorderGaloisCondition}.
\end{proof}

\begin{proposition}
Let $\sSet{A,R}$ and $\sSet{B,S}$ be relational structures.
\begin{enumerate}
\item If $A$ is a poset, then every residuated map $a: A \to B$ has a unique residual.
\item If $B$ is a poset, then every residual map $a': B \to A$ is the residual of a unique residuated map.
\end{enumerate}
\end{proposition}
\begin{proof}
(1) Let $a$ be a residuated map with residuals $a_1'$ and $a_2'$. Then
\[ \id_B \subseteq S \subseteq a_1'Ra_1^{\prime \transp} = a_1'aS = a_1'Ra_2^{\prime \transp}. \]
Similarly $\id_B \subseteq a_2'Ra_1^{\prime \transp}$, which we can transpose to get $\id_B \subseteq a_1'R^\transp a_2^{\prime \transp}$. Together this gives
\[ \id_B \subseteq a_1'(R\cap R^\transp)a_2^{\prime \transp} = a_1'a_2^{\prime \transp}. \]
We conclude using \ref{functionEqualityIdComparison}.

(2) Similar.
\end{proof}


\begin{proposition}
Let $\sSet{A,R}$ and $\sSet{B,S}$ be partial orders. Then every residuated map $a: A \to B$ has a unique residual and every residual map $a': B \to A$ is the residual of a unique residuated map.
\end{proposition}
\begin{proof}
Let $a$ be a residuated map with residuals $a_1'$ and $a_2'$. It is enough to show that $aa_1' = aa_2'$ and $a_1'a = a_2'a$. Indeed \ref{idempotentsInGreensClasses} then shows that $a_1'\mathcal{H}a_2'$ and by \ref{inversesIdempotentsDclass} this means that $a_1' = a_2'$.

To this end we combine $\id_A \subseteq aa_1'R^\transp$, $\id_A \subseteq $
\end{proof}

\subsubsection{Derived Galois connections}
\begin{lemma}
Let $(a, a')$ be a Galois connection between $\sSet{A,R}$ and $\sSet{B,S}$. Then $(a',a)$ is a Galois connection between the dual structures $\sSet{B^o,S^\transp}$ and $\sSet{A^o,R^\transp}$.
\end{lemma}

\begin{lemma}
Let $(a, a')$ be a Galois connection between posets $\sSet{A,R}$ and $\sSet{B,S}$ and $(b, b')$ a Galois connection between posets $\sSet{B,S}$ and $\sSet{A,R}$. Then
\begin{enumerate}
\item $(ab, b'a')$ is a Galois connection between $\sSet{A,R}$ and $\sSet{A,R}$;
\item $(ba, a'b')$ is a Galois connection between $\sSet{B,S}$ and $\sSet{B,S}$.
\end{enumerate}
\end{lemma}
\begin{proof}
We prove (1). The proof of (2) is identical.
By \ref{preorderGaloisIdentity} we just need to verify the Galois identity:
\[ abR = aRb^{\prime\transp} = Ra^{\prime\transp}b^{\prime\transp} = R(b'a')^\transp. \]
\end{proof}

\subsection{Monads and comonads}
\begin{definition}
Let $\sSet{A,R}$ be a relational structure and $f: A\to A$ a function. We call $f$ a
\begin{itemize}
\item \udef{monad} if there exists a relational structure $\sSet{B,S}$ and functions $a: A\to B$ and $a': B\to A$ such that $(a, a')$ is a Galois connection and $f = a'a$;
\item \udef{comonad} if $f = aa'$.
\end{itemize}
\end{definition}

\begin{lemma}
Let $\sSet{A,R}$ be a relational structure and $f: A \to A$ a function. Then
\begin{enumerate}
\item $f$ is a monad \textup{if and only if}
\begin{enumerate}
\item $f$ is relation-preserving;
\item $f$ is idempotent: $f^2 = f$;
\item $f$ is right-restrictive: $R;f^\transp \subseteq R$.
\end{enumerate}
\item $f$ is a comonad \textup{if and only if}
\begin{enumerate}
\item $f$ is relation-preserving;
\item $f$ is idempotent: $f^2 = f$;
\item $f$ is left-restrictive: $f;R \subseteq R$;
\end{enumerate}
\end{enumerate}
\end{lemma}
\begin{proof}
(1) The direction $\Rightarrow$ is clear. Conversely, $\Leftarrow$, we claim the inclusion $\iota: \im(f) \hookrightarrow A$ is residuated with residual $f: A\to \im(f)$.

Indeed, $\iota$ is clearly relation-preserving. Take arbitrary $f(x)\in \im(f)$ and arbitrary $y\in A$. Then 
\begin{align*}
(\iota f \iota)(f(x)) &= \iota(f^2(x)) = \iota(f(x)) \\
(f \iota f)(y) &= f^2(y) = f(y),
\end{align*}
so $\iota f \iota = \iota$ and $f\iota f = f$, meaning $f$ and $\iota$ are generalised inverses.

Finally we check
\begin{align*}
\iota f (R|^{\im f}_{\im(f)}) &\subseteq \iota f \iota (R|^{\im f}_{\im(f)}) = \iota (R|^{\im f}_{\im(f)}) \subseteq R|^{\im f}_{\im(f)} \\
f \iota R^\transp &= f R^\transp = (R;f^\transp)^\transp \subseteq R^\transp.
\end{align*}

(2) Similar.
\end{proof}

Idempotent => image set is set of fixed points.

\begin{proposition}
When is a subset $X\subseteq A$ the image of a (co)monad? For posets: enough that $\upset x \cap X$ has bottom.
\end{proposition}

\begin{proposition}
Bijection monads - images of monads.
\end{proposition}

\begin{definition}
Completeness
\end{definition}

\subsection{Inclusion-preserving functions on powersets}
\url{file:///C:/Users/user/Downloads/(Mathematics%20and%20Its%20Applications%20565)%20Marcel%20Ern%C3%A9%20(auth.),%20K.%20Denecke,%20M.%20Ern%C3%A9,%20S.%20L.%20Wismath%20(eds.)%20-%20Galois%20Connections%20and%20Applications-Springer%20Netherlands%20(2004).pdf}

\url{https://sciendo.com/pdf/10.2478/ausm-2014-0019}

\begin{proposition} \label{polarsGaloisConnection}
Let $R$ be a relation on $(A,B)$. Then the polar functions
\[ \powerset(A)\to\powerset(B)^o: X\mapsto X^R \qquad\text{and}\qquad \powerset(B)^o\to\powerset(A): X\mapsto {^RX} \]
form a Galois connection. Every antitone Galois connection between powersets is of this form, for some relation.
\end{proposition}
\begin{proof}
As $\sSet{\powerset(A), \subseteq}^o$ and $\sSet{\powerset(B), \subseteq}$ are posets, by \ref{preorderGaloisIdentity} we just need to verify the Galois identity: $\forall X\in \powerset(A), Y\in\powerset(B):$ we have
\[ X^R \subseteq^\transp Y \iff X^R \supseteq Y \;\iff\; \Big[ \forall x\in X: \forall y\in Y: xRy \Big] \;\iff\; X \subseteq {^RY}. \]

We can give the same calculation using the language of \ref{polarsCartesianProduct}:
\[ X^R \subseteq^\transp Y \iff X\times Y \subseteq R \iff Y\times X \subseteq R^\transp \iff X \subseteq Y^R. \]

TODO semilattice morphism
\end{proof}
\begin{proposition} \label{imagePreimageGaloisConnection}
Let $R$ be a relation on $(A, B)$. Then
\begin{enumerate}
\item the image function is part of a Galois connection
\[ \powerset(A)\to\powerset(B): X\mapsto X_R \qquad\text{and}\qquad \powerset(B)\to\powerset(A): X\mapsto {^{\overline{R}}(X^c)}; \]
\item the preimage function is part of a Galois connection
\[ \powerset(B)\to\powerset(A): X\mapsto {_RX} \qquad\text{and}\qquad \powerset(A)\to\powerset(B): X\mapsto (X^c)^{\overline{R}}. \]
\end{enumerate}
These Galois connections are equivalent by replacing $R \leftrightarrow R^\transp$. Every isotone Galois connection between powersets is of this form, for some relation.
\end{proposition}
\begin{proof}
We compose the polar Galois connection of $\overline{R}$ with the Galois connection of complementation to get
\[ X_R = (X^{\overline{R}})^c \subseteq Y \iff X^{\overline{R}} \supseteq Y^c \iff X \subseteq {^{\overline{R}}(Y^c)}, \]
by \ref{imageComplementaryRelation}.

Similarly we have
\[ {_RX} = ({^{\overline{R}}X})^c \subseteq Y \iff {^{\overline{R}}}X \supseteq Y^c \iff X \subseteq (Y^c)^{\overline{R}}. \]
\end{proof}
\begin{corollary} \label{functionImagePreimageGaloisConnection}
Let $A,B$ be sets and $f:A\to B$ a function. Then the functions
\[ f^\imf: \powerset(A)\to\powerset(B) \qquad\text{and}\qquad f^\preimf: \powerset(B)\to\powerset(A) \]
form a Galois connection $(f^\imf, f^\preimf)$.
\end{corollary}
\begin{proof}
We just need to prove that, for arbitrary $Y\in \powerset(B)$, ${^{\overline{f}}(Y^c)} = {_fY} = f^\preimf[Y]$. Indeed, using \ref{imageComplementaryRelation} and \ref{imagePreimageUniqueness}, we have
\[ {^{\overline{f}}(Y^c)} = \big(^{\overline{f}}(Y^c)\big)^{cc} = \big(_f(Y^c)\big)^c = {_f(Y^{cc})} = {_fY} = f^\preimf[Y]. \]
\end{proof}
We can also directly verify the Galois identity \ref{preorderGaloisIdentity}:
\[ X_f \subseteq Y \implies X \subseteq X_{f;f^\transp} \subseteq Y_{f^{\transp}} \implies X_f \subseteq Y_{f^{\transp};f} \subseteq Y, \]
using \ref{totalityEquivalences} and \ref{relationTimesTransposeSubsetIdentity}.

\subsubsection{Closure and dual closure}

\begin{corollary} \label{upDownsetUnionIntersection}
Let $\sSet{P,\Yleft}$ be an ordered set and $\mathcal{A}\subseteq \powerset(P)$. Then
\begin{enumerate}
\item $\upset \bigcup \mathcal{A} = \bigcup_{A\in \mathcal{A}} \upset A$ and $\downset \bigcup \mathcal{A} = \bigcup_{A\in \mathcal{A}} \downset A$;
\item $\upset \bigcap \mathcal{A} \subseteq \bigcap_{A\in \mathcal{A}} \upset A$ and $\downset \bigcap \mathcal{A} \subseteq \bigcap_{A\in \mathcal{A}} \downset A$;
\item $\upset \bigcap_{A\in \mathcal{A}} \upset A = \bigcap_{A\in \mathcal{A}} \upset A$ and $\downset \bigcap_{A\in \mathcal{A}} \downset A = \bigcap_{A\in \mathcal{A}} \downset A$.
\end{enumerate}
\end{corollary}
\begin{proof}
(1) We calculate using \ref{unionIntersectionLabelSet}:
\[ \upset \bigcup \mathcal{A} = \bigcup_{x\in \bigcup\mathcal{A}} \upset x = \bigcup_{A\in \mathcal{A}}\bigcup_{x\in A}\upset x = \bigcup_{A\in \mathcal{A}} \upset A. \]

(2) Again we calculate using \ref{unionIntersectionLabelSet}:
\[ \upset \bigcap \mathcal{A} = \bigcup_{x\in \bigcap\mathcal{A}} \upset x \subseteq \bigcap_{A\in \mathcal{A}}\bigcup_{x\in A}\upset x = \bigcap_{A\in \mathcal{A}} \upset A. \]

(3) We calculate using (2) and the fact that closures are idempotent:
\[ \bigcap_{A\in \mathcal{A}} \upset A = \bigcap_{A\in \mathcal{A}} \upset\upset A \supseteq \upset \bigcap_{A\in \mathcal{A}} \upset A \supseteq \bigcap_{A\in \mathcal{A}} \upset A. \]
\end{proof}
Also t
\begin{corollary} \label{unionIntersectionDownUpSets}
Let $P$ be an ordered set and $\{Q_i\}_{i\in I}$ be a set of down sets in $P$. Then
\begin{enumerate}
\item $\bigcup Q_i$ is a down set;
\item $\bigcap Q_i$ is a down set.
\end{enumerate}
The same is true for up sets.
\end{corollary}
\begin{proof}
This follows from $\downset \bigcup Q_i = \bigcup \downset Q_i = \bigcup Q_i$ and $\downset \bigcap Q_i \subseteq \bigcap \downset Q_i = \bigcap Q_i$ by \ref{TODO}.
\end{proof}

\subsubsection{Maps and polars}

\begin{proposition} \label{imagePolars}
Let $\sSet{A, R}$ and $\sSet{B, S}$ be relational structures, $f: A\to B$ a relation-preserving function and $X\subseteq A$ a subset. Then
\begin{enumerate}
\item $f[X^R] \subseteq f[X]^S \cap \im(f)$;
\item $f[{^R}X] \subseteq {^Sf[X]} \cap \im(f)$;
\item $f[\max(X)] \subseteq \max(f[X])$;
\item $f[\min(X)] \subseteq \min(f[X])$.
\end{enumerate}
For relation-reflecting functions we have reversed inclusions. For relation embeddings the inclusions become equalities.
\end{proposition}
\begin{proof}
(1) We calculate, using \ref{boundsFromPrincipalImages} and \ref{functionImagesPreimagesAndPrincipalImages},
\[ f[X^R] = f\left[\bigcap_{x\in X}xR\right] \subseteq \bigcap_{x\in X}f[xR] \subseteq \bigcap_{x\in X}Sf(x) = \bigcap_{y\in f[X]} Sy =  f[S]^S. \]

(b) Dual to (a).

(c) We calculate
\[ f[\max(X)] = f[X\cap X^R] \subseteq f[X]\cap f[X^R] \subseteq f[X]\cap f[X]^S \cap \im(f) = f[X]\cap f[X]^S = \max(f[X]). \]

(d) Dual to (c).
\end{proof}
We cannot say anything about the supremum or infimum for general relation-preserving functions, because $f[X^R] \subseteq f[X]^S$ implies $f[X^R]^{S^\transp} \supseteq (f[X]^S)^{S^\transp}$, so the calculation would be
\[ f[\sup(X)] = f[X^R\cap (X^R)^{R^\transp}] \subseteq f[X]^S \cap f[(X^R)]^{S^\transp} \supseteq f[X]^S \cap (f[X]^S)^{S^\transp} = \sup(f[X]), \]
from which we cannot conclude anything.

\begin{proposition} \label{residuationPreservesSupInf}
Let $\sSet{A, R}$ and $\sSet{B, S}$ be relational structures, $X\subseteq A$ a subset and $f,g : A\to B$ functions.
\begin{enumerate}
\item If $f$ is a residuated map, then $f[\sup(X)] \subseteq \sup(f[X])$.
\item If $g$ is a residual map, then $g[\inf(X)] \subseteq \inf(g[X])$.
\end{enumerate}
\end{proposition}
\begin{proof}
(1) Let $f': B\to A$ be a residual of $f$. From above we see that it is enough to have $f[X^R]^{S^\transp} \subseteq (f[X]^S)^{S^\transp}$.

We use $ff'R \subseteq R$ and $f'fS^\transp \subseteq S^\transp$, to get $X^{ff'R} \subseteq X^{R}$ and $X^{f'fS^\transp} \subseteq X^{S^\transp}$. This allows us to make the following calculation:
\begin{align*}
f[X^R]^{S^\transp} &\subseteq f[X^{ff'R}]^{S^\transp} \\
&\subseteq f[f'[f[X]^S]]^{S^\transp} \\
&= (f[X]^S)^{f'fS^\transp} \\
&\subseteq (f[X]^S)^{S^\transp}.
\end{align*}

(2) The proof in this case is similar. Let $g^-: B\to A$ be a residuated map of which $g$ is a residual. Now it is enough to have $g[X^{R^\transp}]^{S} \subseteq (g[X]^{S^\transp})^{S}$.

Using $X^{g^-gS}\subseteq X^S$ and $X^{gg^-R^\transp} \subseteq X^{R^\transp}$, we calculate
\begin{align*}
g[X^{R^\transp}]^{S} &\subseteq f[X^{gg^-R^\transp}]^{S} \\
&\subseteq g[g^-[g[X]^{S^\transp}]]^{S} 
&= (g[X]^{S^\transp})^{g^-gS} \\
&\subseteq (g[X]^{S^\transp})^{S}.
\end{align*}
\end{proof}

\begin{proposition} \label{GaloisConnectionLatticePreservation}
Let $P, Q$ be partial orders.
\begin{enumerate}
\item If $P$ is a complete $\vee$-semilattice, then an order-preserving function $f: P\to Q$ is residuated \textup{if and only if} $f$ preserves joins. The residual is given by
\[ f^+: Q\to P: y\mapsto \bigvee f^{-1}[\downset y]. \]
\item If $Q$ is a complete $\wedge$-semilattice, then an order-preserving function $g: Q\to P$ is a residual map \textup{if and only if} $g$ preserves meets. It is the residual of the residuated map
\[ g^-: P\to Q: x\mapsto \bigwedge g^{-1}[\upset x]. \]
\end{enumerate}
\end{proposition}
\begin{proof}
Both direction $\Rightarrow$ are given by \ref{residuationPreservesSupInf}.

By \ref{preorderGaloisCondition} it is enough to verify that $f^+$ and $g^-$ are order-preserving and for all $x\in P, y\in Q$:
\[ f^+(f(x)) \leq x, \quad f(f^+(y)) \geq y, \quad g(g^-(x)) \leq x, \quad\text{and}\quad g^-(g(y)) \geq y. \]
To prove $f^+$ is order-preserving, take arbitrary $y_1,y_2\in Q$. Then
\[ y_1 \leq y_2 \implies \downset y_1 \subseteq \downset y_2 \implies f^{-1}[\downset y_1] \subseteq f^{-1}[\downset y_2] \implies \bigvee f^{-1}[\downset y_1] \leq \bigvee f^{-1}[\downset y_2]. \]
The proof for $g^-$ is similar. Now we prove $f^+(f(x)) \leq x$, for any arbitrary $x\in P$:
\[ todo \]
\[ f(f^{+}(y)) = f\left(\bigvee f^{-1}[\downset y]\right) = \bigvee f\left[^{-1}[\downset y]\right] \geq y, \]
where the last inequality follows from $\{y\} \subseteq f\left[^{-1}[\downset y]\right]$.
TODO
\end{proof}
TODO anti-symmetry, means preservation of inf/sup means equality.

\begin{corollary} \label{polarOfUnion}
Let $R$ be a relation on $(A,B)$ and $\mathcal{E}\subseteq \powerset(A)$. Then
\[ \left(\bigcup\mathcal{E}\right)^R = \bigcap\setbuilder{{^RX}}{X\in \mathcal{E}}. \]
\end{corollary}
\begin{proof}
The proposition applied to the Galois connection of polar maps, in \ref{polarsGaloisConnection}.
\end{proof}

\begin{corollary} \label{completeSublattice}
Let $P$ be a partial order and $D\subseteq P$ a subset.
\begin{enumerate}
\item If $P$ is a complete lattice and $\forall S\subseteq D:\; \bigvee_P S \in D$, then $D$ is a complete sublattice and there exists a monad $f: P\to D$ such that for all $S\subseteq D$
\[ \bigvee_D S = \bigvee_P S \qquad\text{and}\qquad \bigwedge_D S = f\left[\bigwedge_P S\right]. \]
\item If $P$ is a complete lattice and $\forall S\subseteq D:\; \bigwedge_P S \in D$, then $D$ is a complete sublattice and there exists a comonad $f: P\to D$ such that for all $S\subseteq D$
\[ \bigvee_D S = f\left[\bigvee_P S\right] \qquad\text{and}\qquad \bigwedge_D S = \bigwedge_P S. \]
\end{enumerate}
\end{corollary}
\begin{proof}
(1) Saying $D$ is closed under arbitrary joins is equivalent to saying the inclusion $D\hookrightarrow P$ preservis joins. By the proposition this means the inclusion is residuated. The rest follows from TODO
\end{proof}
TODO: swap monad - comonad??

\begin{proposition}
Let $P$ be a poset. Then
\begin{enumerate}
\item if $\mathcal{J}\subseteq \powerset(P)$ is the set of subsets of $P$ that have a join, then
\[ \mathcal{J} \to P: A\mapsto \bigvee A \qquad\text{and}\qquad P\to \mathcal{J}: x\to \downset x \]
form a Galois connection;
\item if $\mathcal{M}\subseteq \powerset(P)$ is the set of subsets of $P$ that have a meet, then
\[ P\to \mathcal{M}^o: x\to \upset x \qquad\text{and}\qquad \mathcal{M}^o \to P: A\mapsto \bigwedge A \]
form a Galois connection. 
\end{enumerate}
\end{proposition}
\begin{proof}
(1) We have, for all $A\in \mathcal{J}$ and $x\in P$,
\[ \bigvee A \leq x \qquad \iff\qquad A\subseteq \downset x. \]
(2) We have, for all $A\in \mathcal{M}$ and $x\in P$,
\[ \upset x \supseteq A \qquad \iff\qquad x\leq \bigwedge A. \]
\end{proof}
\begin{corollary} \label{joinMeetUnion}
Let $P$ be a poset. Then
\begin{enumerate}
\item if $\{A_i\}_{i\in I}\subseteq \mathcal{J}$ is a set of subsets such that $\bigcup_{i\in I}A_i \in \mathcal{J}$, then $\big\{\bigvee A_i\big\}_{i\in I} \in \mathcal{J}$ and
\[ \bigvee \Big(\bigcup_{i\in I}A_i\Big) = \bigvee_{i\in I}\Big(\bigvee A_i\Big); \]
\item if $\{A_i\}_{i\in I}\subseteq \mathcal{M}$ is a set of subsets such that $\bigcup_{i\in I}A_i \in \mathcal{M}$, then $\big\{\bigwedge A_i\big\}_{i\in I} \in \mathcal{M}$ and
\[ \bigwedge \Big(\bigcup_{i\in I}A_i\Big) = \bigwedge_{i\in I}\Big(\bigwedge A_i\Big). \]
\end{enumerate}
\end{corollary}
\begin{proof}
Application of \ref{GaloisConnectionLatticePreservation}.
\end{proof}

\subsubsection{Sets of functions and relations}
\begin{proposition} \label{setOfFunctionsToRelationGaloisConnection}
Let $X$ be a set. The function
\[ m: \sSet{\powerset(X\to X), \subseteq} \to \sSet{\powerset(X^2), \subseteq}: F \mapsto \setbuilder{(x,y)\in X^2}{\exists f\in F: \; f(x) = y} \]
is residuated.
\end{proposition}
\begin{proof}
It preserves joins ($\cup$).
\end{proof}

\begin{proposition}
Consider the function
\[ m: \powerset(X\to X) \to \powerset(X^2): F \mapsto \setbuilder{(x,y)\in X^2}{\exists f\in F: \; f(x) = y}. \]
\begin{enumerate}
\item $m(F)$ is transitive \textup{if and only if} $F$ is closed under composition;
\item $m(F)$ is reflexive \textup{if and only if} $F$ contains $\id$.
\end{enumerate}
\end{proposition}

\section{Galois connections}
\begin{proposition}
Let $\sSet{A,R'}$ and $\sSet{B, S'}$ be relational structures. Let $R\subseteq R'$ and $S\subseteq S'$ be idempotent, total and functional subsets. Then there exist functions $f: A\to B$ and $g: B\to A$ such that $R = f;g$ and $S = g;f$. We have
\begin{enumerate}
\item $f,g$ are generalised inverses;
\item $g;R = S;g$ and $R;f = f;S$;
\item $f$ and $g$ are relation preserving;
\item $f;S \subseteq R;g^\transp$ and $f^\transp ;R \subseteq S;g$;
\item $g;R;g^\transp = g;f;S;(g;f)^\transp$ and $f;S;f^\transp = f;g;R;(f;g)^\transp$;
\item $g;R;(fg)^\transp = S;f^\transp$ and $R;g^\transp = f;S;(gf)^\transp$.
\end{enumerate}
\end{proposition}
\begin{proof}
(1) TODO ref.

(2) We have $g;R = g;(f;g) = (g;f);g = S;g$ and  $R;f = (f;g);f = f;(g;f) = f;S$.

(3) From points (2), (3) using \ref{relationPreserving}.

(4) We have $f;S \subseteq f;S;g;g^\transp = f;g;f;g;g^\transp = R;g^\transp$.

(5) We have $g;R;g^\transp \subseteq g;f;S;f^\transp;g^\transp \subseteq g;f;g;R;g^\transp; f^\transp; g^\transp = g;R;g^\transp$.

(6) We have (using (5)), $g;R;(fg)^\transp = g;f;S;(gf)^\transp;f^\transp = S;f^\transp$ and $f;S;(gf)^\transp = f;g;R;(fg)^\transp; g^\transp = R;g^\transp$.
\end{proof}

\section{The category of relational structures}
\subsection{Products}
\begin{proposition}
The product is the Cartesian product with pointwise relation.
\end{proposition}

\chapter{Graphs}
\input{graphs}

\chapter{Groups}
\input{groups}


\chapter{Rings and fields}
TODO: signature $\sSet{R,+,\cdot, 0, 1}$.
TODO: addition, multiplication and scalar multiplication of functions: pointwise.

TODO: unital homomorphisms; unital subalgebra.

\begin{lemma}
Let $R$ be a ring and $a\in R$.
\begin{enumerate}
\item If $a$ has a left and a right inverse, they are equal. Thus $a$ has an inverse.
\item The inverse of $a$ is unique, if it exists.
\end{enumerate}
\end{lemma}
\begin{proof}
Let $l$ be a left inverse of $a$ and $r$ a right inverse. Then
\[ l = l(ar) = (la)r = r. \]
The unicity of the inverse is an easy consequence.
\end{proof}

\begin{lemma} \label{productInvertibility}
Let $R$ be a ring and $a,b\in R$. Then $a$ and $b$ are invertible \textup{if and only if} $ab$ and $ba$ are invertible.
\end{lemma}
\begin{proof}
Assume $a,b$ invertible. Then $b^{-1}a^{-1}$ is an inverse for $ab$ and $a^{-1}b^{-1}$ is an inverse for $ba$.

Assume both $ab$ and $ba$ have inverses. Then from
\begin{align*}
a[b(ab)^{-1}] &= \vec{1} & [(ba)^{-1}b]a &= \vec{1} \\
[(ab)^{-1}a]b &= \vec{1} & b[a(ba)^{-1}] &= \vec{1}
\end{align*} 
we see that both $a$ and $b$ have left and right inverses.
\end{proof}

\begin{proposition} \label{everyProperIdealInMaximalIdeal}
Every proper ideal is contained in a maximal ideal.
\end{proposition}

\begin{lemma} \label{nonInvertibleGeneratedIdeals}
Let $R$ be a unital ring. If $a\in R$ is non-invertible, then the generated ideal $(a)$ is not the whole ring.
\end{lemma}
\begin{proof}
If $(a) = R$, then $1\in (a)$, implying $ab=1$ for some $b\in R$. A contradiction.
\end{proof}

\begin{proposition}
Let $f$ be a ring homomorphism. If $f$ is invertible as a function (i.e.\ bijective), its inverse $f^{-1}$ is also a ring homomorphism.
\end{proposition}

\begin{proposition} \label{kernelIsIdeal}
Kernel of Ring Homomorphism is Ideal
\end{proposition}

\begin{definition}
A $*$-rng is a structured set $(R,+,\cdot, *)$, where $R$ is a rng and $*:R\to R$ is an involutive anti-automorphism. That is, $\forall x,y\in R$:
\begin{itemize}
\item $(xy)^* = y^*x^*$;
\item $(x+y)^* = x^* + y^*$;
\item $(x^*)^* = x$.
\end{itemize}
This is also known as an \udef{involutive rng} or \udef{rng with involution}.
\end{definition}
\begin{lemma}
If $R$ is a unital ring with involution, then $1^* = 1$.
\end{lemma}
\begin{proof}
From $1^*x = (x^*1)^* = (x^*)^* = x$, we see that $1^*$ is a multiplicative identity, which is unique.
\end{proof}
\begin{definition}
An element of a $*$-rng is \udef{self-adjoint} if $x^* = x$.
\end{definition}

\section{Ideals}
TODO $\genIdeal{X}$ is ideal generated by $X$.

ALSO $\genIdealBuilder{x\otimes y - b(x,y)}{x\in X, y\in Y}$

\section{Types of elements}
\subsection{Zero divisors}
\begin{definition}
Let $R$ be a rng. An element $x\in R$ is called
\begin{itemize}
\item a \udef{left zero divisor} if $\exists y \in R\setminus\{0\}: xy = 0$;
\item a \udef{right zero divisor} if $\exists y \in R\setminus\{0\}: yx = 0$;
\item a \udef{zero divisor} if it is either a left or a right zero divisor.
\end{itemize}
\end{definition}

\begin{lemma} \label{inverseZeroDivisor}
Let $R$ be a ring and $x\in R$.
\begin{enumerate}
\item If $x$ is a left zero divisor, it has no left inverse.
\item If $x$ is a right zero divisor, it has no right inverse.
\item If $x$ is a zero divisor, it has no inverse.
\end{enumerate}
\end{lemma}
\begin{proof}
Assume $x$ is a left zero divisor, with $y\neq 0$ such that $xy = 0$. Assume, towards a contradiction, that $z$ is a left inverse of $x$. Then
\[ y = 1y = (zx)y = z(xy) = 0, \]
which is disallowed by definition.

The rest follows by duality.
\end{proof}

\subsection{Nilpotents}
\begin{definition}
Let $R$ be a rng. An element $x\in R$ is called \udef{nilpotent} if there exists $k\in \N$ such that $x^k = 0$. The least such $k$ is called the \udef{index} of the nilpotent.
\end{definition}

\section{Group rings}
\begin{definition}
Let $G$ be a finite group and $R$ a r(i)ng. The \udef{group ring} $RG$ is the set of functions $(G\to R)$ with pointwise addition and the convolution product
\[ (x\star y)(g) = \sum_h x(h)y(h^{-1}g) = \sum_{g=hk}x(h)y(k) \]
for all $x,y\in RG$ and $g\in G$. 
\end{definition}
The a group ring can be seen as a free module generated by $G$. (TODO: this as definition?)

\section{Integral domains}

\subsection{Bézout domains}
\begin{theorem}[Bézout-Bachet]
TODO
\end{theorem}
Also known as Bézout's identity.

\section{Fields}
\subsection{Totally ordered fields}
\begin{definition}
Let $K$ be a set with binary operations $+,\cdot$ such that $(K,+,\cdot)$ is a field and a binary relation $\leq$ such that $(F,\leq)$ is a total order. Then the structured set $(K,+,\cdot,\leq)$ is a \udef{totally ordered field} if $\forall a,x,y\in K$:
\begin{enumerate}
\item $x\leq y \implies x+a \leq y+a$;
\item $x\leq y \land a\geq 0 \implies ax \leq ay$;
\item $x\leq y \land a\leq 0 \implies ax \geq ay$.
\end{enumerate}
\end{definition}

\begin{lemma}
Let $(K,+,\cdot,\leq)$ be a totally ordered field and $a,b,c,d\in K$. Then
\begin{enumerate}
\item $a\leq b \land c\leq d \implies (a+c) \leq (b+d)$;
\item $a\leq b \implies -b\leq -a$;
\item $a\geq 0 \iff -a\leq 0$;
\item $a\geq 0 \land b\geq 0 \implies ab \geq 0$;
\item $a\geq 0 \implies a^n \geq 0$ for all $n\in\N$;
\item $a\leq 0 \implies (a^{2n} \geq 0 \land a^{2n+1}\leq 0)$ for all $n\in\N$;
\item $a > 0 \iff a^{-1} > 0$ and $a < 0 \iff a^{-1} < 0$;
\item if $b \geq a>0$, then $b^{-1} \leq a^{-1}$;
\item $0<1$.
\end{enumerate}
\end{lemma}
\begin{proof}
(1) By applying point 1. of the definition twice, we get $(a+c)\leq(b+c)\leq(b+d)$.

(2) This is the result of multiplying by $-1$.

(3) Idem, using $-0=0$.

(4) Special case of point 2. of the definition.

(5) By induction on $n$ and point 2. of the definition.

(6) By induction on $n$ and point 3. of the definition.

(7) By multiplying $a \geq 0$ with $(a^{-1})^{2}$, which is positive, we get $a^{-1}\geq 0$. Also $a\neq 0 \iff a^{-1}\neq 0$.

(8) By point 7. and point 4. of the lemma $a^{-1}b^{-1}$ is positive, so multiplying $b\geq a$ by $a^{-1}b^{-1}$ yields $b^{-1} \leq a^{-1}$.

(9) Assume, towards a contradiction, that this is false, so $1\leq 0$. Then $1$ is negative and multiplying the inequality with $1$ yields $1\cdot 1 \geq 1\cdot 0$, or $1\geq 0$. Taking both inequalities gives $1=0$ by anti-symmetry, which is prohibited for fields.
\end{proof}

\begin{definition}
Let $F\subset K$ be totally ordered fields. Then we call $F$ \udef{dense} in $K$ if
\[ \forall a,b\in K: \exists x\in F: a<x<b. \]
\end{definition}
TODO: topology definition?

\subsection{Field extensions}
\subsubsection{Complex numbers}
\begin{definition}
We write
\begin{itemize}
\item $\C^{\uparrow} \defeq \setbuilder{z\in\C}{\Im(z) \geq 0}$ for the (open) upper half plane;
\item $\C^{\downarrow} \defeq \setbuilder{z\in\C}{\Im(z) \leq 0}$ for the (open) lower half plane;
\item $\C^{\leftarrow} \defeq \setbuilder{z\in\C}{\Re(z) \leq 0}$ for the (open) left half plane;
\item $\C^{\rightarrow}  \defeq \setbuilder{z\in\C}{\Re(z) \geq 0}$ for the (open) right half plane.
\end{itemize}
\end{definition}

\section{Polynomials over rings and fields}
\url{https://www.math.uci.edu/~ndonalds/math120b/2poly.pdf}

TODO notation $p[x]$.

\begin{proposition}
Let $R$ be a ring. Then $R[x]$ is a PID \textup{if and only if} $R$ is a field.
\end{proposition}
\begin{corollary}
Bézout's identity.

...
\end{corollary}


\begin{proposition}
Polynomials over fields have unique prime decompositions.
\end{proposition}

\subsection{Rings and fields of functions}
TODO notation p[X](z).

\subsubsection{Algebroid functions}

\chapter{Valuation theory}
Absolute values on integral domains.